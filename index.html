<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>MiniShop (fixed)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:Inter,Arial,Helvetica,sans-serif;margin:0;background:#f4f6f8;color:#111}
    header{background:#0b5cff;color:#fff;padding:12px 16px;display:flex;align-items:center;gap:12px}
    header a, header button{color:#fff;text-decoration:none}
    .container{max-width:1000px;margin:20px auto;padding:0 12px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
    .card{background:#fff;border-radius:8px;padding:12px;box-shadow:0 2px 6px rgba(0,0,0,.06)}
    img.prod{width:100%;height:160px;object-fit:cover;border-radius:6px}
    .small{font-size:.9rem;color:#555}
    .btn{background:#0b5cff;color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer}
    .secondary{background:#e6eefc;color:#0b5cff}
    input,textarea{width:100%;padding:8px;border-radius:6px;border:1px solid #d9dce1}
    .row{display:flex;gap:8px;align-items:center}
    .top-controls{margin-bottom:12px;display:flex;gap:8px;align-items:center}
    .hidden{display:none}
    .error{color:#b00000}
    footer{padding:24px;text-align:center;color:#666}
    .placeholder{width:100%;height:160px;border-radius:6px;background:#e9eef8;display:flex;align-items:center;justify-content:center;color:#6b7a9a}
  </style>
</head>
<body>
  <header>
    <strong>MiniShop</strong>
    <nav style="margin-left:12px">
      <a href="#" id="link-home">Home</a> |
      <a href="#" id="link-add-product">Add Product</a> |
      <a href="#" id="link-my-orders">My Orders</a> |
      <a href="#" id="link-admin-orders">Orders (Admin)</a>
    </nav>
    <div style="margin-left:auto" id="auth-area"></div>
  </header>

  <div class="container">
    <div id="view-home" class="view">
      <div class="top-controls">
        <div id="welcome-text" class="small"></div>
        <div style="margin-left:auto">
          <button class="btn" id="btn-refresh">Refresh</button>
        </div>
      </div>
      <h2>Products</h2>
      <div id="products" class="grid"></div>
    </div>

    <div id="view-login" class="view hidden card">
      <h3>Login</h3>
      <div id="login-error" class="error"></div>
      <div>
        <label>First name (login name)</label><br>
        <input id="login-first" />
      </div>
      <div>
        <label>Password</label><br>
        <input id="login-pass" type="password" />
      </div>
      <div>
        <label><input type="checkbox" id="login-keep"> Keep me signed in</label>
      </div>
      <div style="margin-top:8px">
        <button class="btn" id="btn-login">Login</button>
        <button class="secondary btn" id="btn-to-register">Create account</button>
      </div>
    </div>

    <div id="view-register" class="view hidden card">
      <h3>Create Account</h3>
      <div id="register-error" class="error"></div>
      <div>
        <label>First name</label><br><input id="reg-first" />
      </div>
      <div>
        <label>Father name</label><br><input id="reg-father" />
      </div>
      <div>
        <label>Password</label><br><input id="reg-pass" type="password" />
      </div>
      <div style="margin-top:8px">
        <button class="btn" id="btn-register">Create account</button>
        <button class="secondary btn" id="btn-to-login">Back to login</button>
      </div>
      <p class="small">Login uses first name + password (first names must be unique for your current setup).</p>
    </div>

    <div id="view-add-product" class="view hidden card">
      <h3>Add Product (Admin only)</h3>
      <div id="add-error" class="error"></div>
      <div id="admin-notice" class="small">If you are not admin yet, click "Enter admin code" below to become admin (server checks code). The admin code is not stored in this site.</div>
      <div style="margin-top:8px" id="admin-code-box">
        <input id="admin-code" placeholder="Enter admin code" />
        <button class="btn" id="btn-enter-admin">Enter admin code</button>
      </div>

      <div id="add-form" class="hidden" style="margin-top:12px">
        <div><label>Product name</label><br><input id="prod-name" /></div>
        <div><label>Description</label><br><textarea id="prod-desc"></textarea></div>
        <div><label>Price (USD)</label><br><input id="prod-price" type="number" step="0.01" /></div>
        <div><label>Photo</label><br><input id="prod-photo" type="file" accept="image/*" /></div>
        <div style="margin-top:8px">
          <button class="btn" id="btn-add-product">Add product</button>
        </div>
      </div>
    </div>

    <div id="view-product" class="view hidden card"></div>

    <div id="view-my-orders" class="view hidden card">
      <h3>My Orders</h3>
      <div id="my-orders-list"></div>
    </div>

    <div id="view-admin-orders" class="view hidden card">
      <h3>All Orders (Admin)</h3>
      <div id="admin-orders-list"></div>
    </div>

  </div>

  <footer><small>MiniShop demo â€¢ Data saved in your Firebase project</small></footer>

  <!-- Firebase scripts (modular SDK) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut,
      setPersistence,
      browserLocalPersistence,
      browserSessionPersistence,
      onAuthStateChanged,
      getIdTokenResult
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import {
      getFirestore,
      collection, addDoc, getDocs, doc, setDoc, getDoc,
      query, where, orderBy, deleteDoc, updateDoc
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import {
      getStorage, ref as sref, uploadBytes, getDownloadURL, deleteObject
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js";

    // ---------- Firebase config (provided) ----------
    const firebaseConfig = {
      apiKey: "AIzaSyCOrJhv-bit0awn3mJacHbjEFnolzv0Ntw",
      authDomain: "minishop-67dbf.firebaseapp.com",
      databaseURL: "https://minishop-67dbf-default-rtdb.firebaseio.com",
      projectId: "minishop-67dbf",
      storageBucket: "minishop-67dbf.appspot.com",
      messagingSenderId: "7379826226",
      appId: "1:7379826226:web:4d8f6f9cbc679cc600ae2b",
      measurementId: "G-6N23NYNRDB"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const functions = getFunctions(app);

    // ---------- UI helpers ----------
    const views = {
      home: document.getElementById('view-home'),
      login: document.getElementById('view-login'),
      register: document.getElementById('view-register'),
      addProduct: document.getElementById('view-add-product'),
      product: document.getElementById('view-product'),
      myOrders: document.getElementById('view-my-orders'),
      adminOrders: document.getElementById('view-admin-orders')
    };
    function show(view) {
      Object.values(views).forEach(v => v.classList.add('hidden'));
      view.classList.remove('hidden');
    }
    document.getElementById('link-home').onclick = e => { e.preventDefault(); show(views.home); loadProducts(); };
    document.getElementById('link-add-product').onclick = e => { e.preventDefault(); show(views.addProduct); };
    document.getElementById('link-my-orders').onclick = e => { e.preventDefault(); show(views.myOrders); loadMyOrders(); };
    document.getElementById('link-admin-orders').onclick = e => { e.preventDefault(); show(views.adminOrders); loadAdminOrders(); };

    // ---------- Auth UI logic ----------
    const authArea = document.getElementById('auth-area');
    function renderAuthArea(user, isAdmin) {
      authArea.innerHTML = '';
      if (!user) {
        const l = document.createElement('button'); l.textContent='Login'; l.className='btn'; l.onclick = ()=> show(views.login);
        const r = document.createElement('button'); r.textContent='Register'; r.className='secondary btn'; r.onclick = ()=> show(views.register);
        authArea.appendChild(l); authArea.appendChild(document.createTextNode(' ')); authArea.appendChild(r);
        document.getElementById('welcome-text').textContent = '';
      } else {
        const span = document.createElement('span'); span.textContent = `Hi, ${user.firstName}`;
        authArea.appendChild(span);
        authArea.appendChild(document.createTextNode(' '));
        const logout = document.createElement('button'); logout.textContent='Logout'; logout.className='btn';
        logout.onclick = async ()=>{
          try { await signOut(auth); } catch(e){ console.error('Signout failed', e); }
        };
        authArea.appendChild(logout);
        if (isAdmin) {
          const badge = document.createElement('span'); badge.textContent = ' Admin'; badge.style.marginLeft='8px';
          badge.style.background='#ffefc2'; badge.style.padding='4px 6px'; badge.style.borderRadius='6px';
          authArea.appendChild(badge);
        }
        document.getElementById('welcome-text').textContent = `Signed in as ${user.firstName} ${user.fatherName || ''}`;
      }
    }

    // ---------- small navigation helpers ----------
    document.getElementById('btn-to-login').onclick = ()=> show(views.login);
    document.getElementById('btn-to-register').onclick = ()=> show(views.register);

    // ---------- Registration ----------
    document.getElementById('btn-register').onclick = async () => {
      const first = document.getElementById('reg-first').value.trim();
      const father = document.getElementById('reg-father').value.trim();
      const pass = document.getElementById('reg-pass').value;
      document.getElementById('register-error').textContent = '';
      if (!first || !father || !pass) { document.getElementById('register-error').textContent = 'All fields required.'; return; }
      try {
        const email = `${first.toLowerCase()}@minishop.local`;
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        const u = cred.user;
        await setDoc(doc(db, 'users', u.uid), { firstName: first, fatherName: father });
        show(views.home);
      } catch (err) {
        console.error(err);
        document.getElementById('register-error').textContent = err?.message || 'Could not create account.';
      }
    };

    // ---------- Login ----------
    document.getElementById('btn-login').onclick = async () => {
      document.getElementById('login-error').textContent = '';
      const first = document.getElementById('login-first').value.trim();
      const pass = document.getElementById('login-pass').value;
      const keep = document.getElementById('login-keep').checked;
      if (!first || !pass) { document.getElementById('login-error').textContent = 'Name and password required.'; return; }
      try {
        if (keep) await setPersistence(auth, browserLocalPersistence); else await setPersistence(auth, browserSessionPersistence);
        const email = `${first.toLowerCase()}@minishop.local`;
        await signInWithEmailAndPassword(auth, email, pass);
        show(views.home);
      } catch (err) {
        console.error(err);
        document.getElementById('login-error').textContent = 'Invalid name or password.';
      }
    };

    // ---------- Admin callable ----------
    const makeAdminFn = httpsCallable(functions, 'makeAdmin');
    document.getElementById('btn-enter-admin').onclick = async () => {
      const code = document.getElementById('admin-code').value.trim();
      document.getElementById('add-error').textContent = '';
      if (!code) { document.getElementById('add-error').textContent = 'Enter admin code.'; return; }
      if (!auth.currentUser) { document.getElementById('add-error').textContent = 'Sign in first.'; return; }
      try {
        await makeAdminFn({ code });
        // force-refresh token so we see custom claim
        await auth.currentUser.getIdToken(true);
        alert('Admin claim (if code correct) applied.');
        const admin = await isCurrentUserAdmin();
        toggleAddProductForm(admin);
        renderAuthArea(currentProfile, admin);
      } catch (err) {
        console.error(err);
        document.getElementById('add-error').textContent = 'Incorrect admin code or error.';
      }
    };

    // ---------- Products (listing, add, delete) ----------
    const productsDiv = document.getElementById('products');

    async function loadProducts() {
      productsDiv.innerHTML = 'Loading...';
      try {
        const snap = await getDocs(collection(db, 'products'));
        const docs = snap.docs.map(d=>({ id:d.id, ...d.data() })).sort((a,b)=> (b.createdAt||0)-(a.createdAt||0));
        productsDiv.innerHTML = '';
        if (docs.length === 0) productsDiv.innerHTML = '<div class="card">No products.</div>';
        docs.forEach(p => {
          const c = document.createElement('div'); c.className='card';
          if (p.imageUrl) {
            const img = document.createElement('img'); img.className='prod'; img.src = p.imageUrl; c.appendChild(img);
          } else {
            const ph = document.createElement('div'); ph.className='placeholder'; ph.textContent='No photo'; c.appendChild(ph);
          }
          const h = document.createElement('h4'); h.textContent = p.name; c.appendChild(h);
          const d = document.createElement('p'); d.className='small'; d.textContent = p.description || ''; c.appendChild(d);
          const pr = document.createElement('p'); pr.innerHTML = `<strong>Price:</strong> $${parseFloat(p.price||0).toFixed(2)}`; c.appendChild(pr);
          const row = document.createElement('div'); row.className='row';
          const more = document.createElement('button'); more.className='btn'; more.textContent='More'; more.onclick = ()=> showProduct(p.id); row.appendChild(more);
          if (auth.currentUser) {
            const ord = document.createElement('button'); ord.className='secondary btn'; ord.textContent='Order'; ord.onclick = ()=> placeOrder(p); row.appendChild(ord);
          } else {
            const loginToOrder = document.createElement('a'); loginToOrder.href='#'; loginToOrder.textContent='Login to order'; loginToOrder.onclick = (e)=>{ e.preventDefault(); show(views.login); }; row.appendChild(loginToOrder);
          }
          // show delete if admin
          isCurrentUserAdmin().then(isAdmin=>{
            if (isAdmin) {
              const del = document.createElement('button'); del.className='btn'; del.style.background='#b00020'; del.textContent='Delete';
              del.onclick = ()=> deleteProduct(p.id, p.imagePath, p.imageUrl);
              row.appendChild(del);
            }
          }).catch(err=>console.warn('admin check error', err));
          c.appendChild(row);
          productsDiv.appendChild(c);
        });
      } catch (err) {
        console.error('loadProducts', err);
        productsDiv.innerHTML = '<div class="card">Could not load products.</div>';
      }
    }

    async function showProduct(productId) {
      try {
        const d = await getDoc(doc(db,'products',productId));
        if (!d.exists()) { alert('Product not found'); return; }
        const p = { id:d.id, ...d.data() };
        const view = document.getElementById('view-product');
        view.innerHTML = '';
        const c = document.createElement('div'); c.className='card';
        const h = document.createElement('h3'); h.textContent = p.name; c.appendChild(h);
        if (p.imageUrl) {
          const img = document.createElement('img'); img.src = p.imageUrl; img.className='prod'; c.appendChild(img);
        } else {
          const ph = document.createElement('div'); ph.className='placeholder'; ph.textContent='No photo'; c.appendChild(ph);
        }
        const desc = document.createElement('p'); desc.textContent = p.description || ''; c.appendChild(desc);
        const price = document.createElement('p'); price.innerHTML = `<strong>Price:</strong> $${parseFloat(p.price||0).toFixed(2)}`; c.appendChild(price);
        const row = document.createElement('div'); row.className='row';
        if (auth.currentUser) {
          const ord = document.createElement('button'); ord.className='btn'; ord.textContent='Order'; ord.onclick = ()=> placeOrder(p); row.appendChild(ord);
        } else {
          const a = document.createElement('a'); a.href='#'; a.textContent='Login to order'; a.onclick = (e)=>{ e.preventDefault(); show(views.login); }; row.appendChild(a);
        }
        c.appendChild(row);
        view.appendChild(c);
        show(views.product);
      } catch (err) {
        console.error(err);
        alert('Could not load product.');
      }
    }

    function toggleAddProductForm(isAdmin) {
      if (isAdmin) {
        document.getElementById('admin-code-box').classList.add('hidden');
        document.getElementById('add-form').classList.remove('hidden');
      } else {
        document.getElementById('admin-code-box').classList.remove('hidden');
        document.getElementById('add-form').classList.add('hidden');
      }
    }

    async function isCurrentUserAdmin() {
      if (!auth.currentUser) return false;
      try {
        const tok = await getIdTokenResult(auth.currentUser); // correct usage
        return !!tok?.claims?.admin;
      } catch (err) {
        console.error('isCurrentUserAdmin error', err);
        return false;
      }
    }

    // add product
    document.getElementById('btn-add-product').onclick = async () => {
      document.getElementById('add-error').textContent = '';
      const name = document.getElementById('prod-name').value.trim();
      const desc = document.getElementById('prod-desc').value.trim();
      const price = parseFloat(document.getElementById('prod-price').value);
      const file = document.getElementById('prod-photo').files[0];
      if (!name || !price || !file) { document.getElementById('add-error').textContent = 'Name, price and photo required.'; return; }
      const ok = await isCurrentUserAdmin();
      if (!ok) { document.getElementById('add-error').textContent = 'Admin required.'; return; }
      try {
        const stRef = sref(storage, `products/${Date.now()}-${file.name}`);
        await uploadBytes(stRef, file);
        const url = await getDownloadURL(stRef);
        await addDoc(collection(db, 'products'), {
          name, description: desc, price: price, imageUrl: url, imagePath: stRef.fullPath, createdAt: Date.now()
        });
        alert('Product added');
        document.getElementById('prod-name').value=''; document.getElementById('prod-desc').value=''; document.getElementById('prod-price').value=''; document.getElementById('prod-photo').value='';
        loadProducts();
      } catch (err) {
        console.error('add product', err);
        document.getElementById('add-error').textContent = 'Could not add product.';
      }
    };

    // delete product
    async function deleteProduct(productId, imagePath, imageUrl) {
      if (!confirm('Delete product?')) return;
      const ok = await isCurrentUserAdmin();
      if (!ok) { alert('Admin required.'); return; }
      try {
        if (imagePath) {
          const delRef = sref(storage, imagePath);
          await deleteObject(delRef).catch(()=>{/* ignore not found */});
        }
        await deleteDoc(doc(db, 'products', productId));
        alert('Deleted');
        loadProducts();
      } catch (err) {
        console.error('deleteProduct', err);
        alert('Could not delete product');
      }
    }

    // ---------- Orders ----------
    async function placeOrder(productOrId) {
      let p = productOrId;
      try {
        if (typeof p === 'string') {
          const d = await getDoc(doc(db, 'products', p));
          if (!d.exists()) { alert('Product not found'); return; }
          p = { id:d.id, ...d.data() };
        }
        if (!auth.currentUser) { show(views.login); return; }
        const userDoc = await getDoc(doc(db, 'users', auth.currentUser.uid));
        const userSnapshot = userDoc.exists() ? userDoc.data() : { firstName:'', fatherName:'' };
        await addDoc(collection(db, 'orders'), {
          userId: auth.currentUser.uid,
          userFirstName: userSnapshot.firstName || '',
          userFatherName: userSnapshot.fatherName || '',
          productId: p.id,
          productName: p.name,
          productPrice: p.price,
          productImage: p.imageUrl || '',
          status: 'Pending',
          createdAt: Date.now()
        });
        alert('Order placed');
        show(views.myOrders); loadMyOrders();
      } catch (err) {
        console.error('placeOrder', err);
        alert('Could not place order');
      }
    }

    async function loadMyOrders() {
      if (!auth.currentUser) { show(views.login); return; }
      try {
        const q = query(collection(db, 'orders'), where('userId', '==', auth.currentUser.uid), orderBy('createdAt','desc'));
        const snap = await getDocs(q);
        const rows = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        const out = document.getElementById('my-orders-list'); out.innerHTML = '';
        if (rows.length===0) out.innerHTML = '<div class="card">You have no orders.</div>';
        rows.forEach(o=>{
          const c = document.createElement('div'); c.className='card';
          const h = document.createElement('h4'); h.textContent = o.productName; c.appendChild(h);
          const s = document.createElement('p'); s.innerHTML = `<strong>Status:</strong> ${o.status}`; c.appendChild(s);
          const t = document.createElement('p'); t.className='small'; t.textContent = `Ordered at: ${new Date(o.createdAt).toLocaleString()}`; c.appendChild(t);
          if (o.productImage) { const img = document.createElement('img'); img.src=o.productImage; img.className='prod'; img.style.height='120px'; c.appendChild(img); }
          if (o.status !== 'Delivered') {
            const cancel = document.createElement('button'); cancel.className='btn'; cancel.textContent='Cancel'; cancel.onclick = async ()=>{
              if (!confirm('Cancel order?')) return;
              try { await deleteDoc(doc(db, 'orders', o.id)); loadMyOrders(); } catch(e){ console.error(e); alert('Could not cancel'); }
            };
            c.appendChild(cancel);
          }
          out.appendChild(c);
        });
      } catch (err) {
        console.error('loadMyOrders', err);
        document.getElementById('my-orders-list').innerHTML = '<div class="card">Could not load orders.</div>';
      }
    }

    // ---------- Admin: load & update orders ----------
    async function loadAdminOrders() {
      const ok = await isCurrentUserAdmin();
      if (!ok) { document.getElementById('admin-orders-list').innerHTML = '<div class="card">Admin only. Enter admin code to manage.</div>'; return; }
      try {
        const snap = await getDocs(collection(db, 'orders'));
        const rows = snap.docs.map(d=>({ id:d.id, ...d.data() })).sort((a,b)=> (b.createdAt||0)-(a.createdAt||0));
        const out = document.getElementById('admin-orders-list'); out.innerHTML = '';
        if (rows.length===0) out.innerHTML = '<div class="card">No orders yet.</div>';
        rows.forEach(o=>{
          const c = document.createElement('div'); c.className='card';
          const h = document.createElement('h4'); h.textContent = o.productName; c.appendChild(h);
          const by = document.createElement('p'); by.className='small'; by.textContent = `Ordered by: ${o.userFirstName} ${o.userFatherName}`; c.appendChild(by);
          const s = document.createElement('p'); s.innerHTML = `<strong>Status:</strong> ${o.status}`; c.appendChild(s);
          const t = document.createElement('p'); t.className='small'; t.textContent = `At: ${new Date(o.createdAt).toLocaleString()}`; c.appendChild(t);
          const row = document.createElement('div'); row.className='row';
          ['Declined','Accepted','Delivered'].forEach(st=>{
            const b = document.createElement('button'); b.className='btn'; b.textContent = st; b.onclick = async ()=>{
              try { await updateDoc(doc(db, 'orders', o.id), { status: st }); loadAdminOrders(); } catch(e){ console.error(e); alert('Could not update'); }
            }; row.appendChild(b);
          });
          c.appendChild(row);
          out.appendChild(c);
        });
      } catch (err) {
        console.error('loadAdminOrders', err);
        document.getElementById('admin-orders-list').innerHTML = '<div class="card">Could not load orders.</div>';
      }
    }

    // ---------- Auth state ----------
    let currentProfile = null;
    onAuthStateChanged(auth, async user => {
      try {
        if (user) {
          const ud = await getDoc(doc(db, 'users', user.uid));
          currentProfile = ud.exists() ? ud.data() : { firstName:'', fatherName:'' };
          const admin = await isCurrentUserAdmin();
          renderAuthArea(currentProfile, admin);
          toggleAddProductForm(admin);
          loadProducts();
        } else {
          currentProfile = null;
          renderAuthArea(null,false);
          toggleAddProductForm(false);
          loadProducts();
        }
      } catch (err) {
        console.error('onAuthStateChanged handler', err);
      }
    });

    // ---------- initial UI ----------
    show(views.home);
    document.getElementById('btn-refresh').onclick = loadProducts;
    loadProducts();

  </script>
</body>
</html>