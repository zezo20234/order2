<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mini Shop</title>
  <style>
    :root{--accent:#0b74de;--muted:#666}
    body{font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;margin:0;background:#f6f8fb;color:#111}
    header{display:flex;align-items:center;gap:12px;padding:12px 18px;background:#fff;border-bottom:1px solid #eee}
    header img.logo{width:25px;height:25px}
    header h1{font-size:18px;margin:0}
    .container{max-width:1100px;margin:22px auto;padding:0 18px}
    .toolbar{display:flex;gap:10px;margin-bottom:14px}
    .btn{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
    .btn.secondary{background:#fff;color:var(--accent);border:1px solid #0b74de}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
    .card{background:#fff;padding:12px;border-radius:10px;box-shadow:0 4px 12px rgba(10,10,10,0.03);display:flex;flex-direction:column}
    .card img{width:100%;height:150px;object-fit:cover;border-radius:8px}
    .meta{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
    .price{font-weight:700}
    footer{padding:18px;text-align:center;color:var(--muted);font-size:13px}

    /* modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:9999}
    .modal{background:#fff;padding:18px;border-radius:10px;min-width:320px;max-width:720px}
    .field{display:flex;flex-direction:column;margin-bottom:8px}
    .field label{font-size:13px;margin-bottom:6px}
    .field input,.field textarea{padding:8px;border-radius:6px;border:1px solid #ddd}
    .small{font-size:13px;color:var(--muted)}
    .orders-list{display:flex;flex-direction:column;gap:8px}
    .order-row{background:#fff;padding:10px;border-radius:8px;display:flex;justify-content:space-between;align-items:center}
    .chip{padding:6px 8px;border-radius:999px;background:#f1f5f9;font-size:13px}
    .actions{display:flex;gap:8px}

    @media (max-width:600px){header h1{font-size:16px}.card img{height:120px}}
  </style>
</head>
<body>
  <header>
    <img src="money.png" alt="logo" class="logo" />
    <h1>Mini Shop</h1>
  </header>

  <main class="container">
    <div class="toolbar">
      <button class="btn" id="addProductBtn">+ Add Product</button>
      <button class="btn secondary" id="adminOrdersBtn">Admin Orders (code)</button>
      <button class="btn secondary" id="myOrdersBtn">My Orders</button>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <input id="searchInput" placeholder="Search products..." style="padding:8px;border-radius:8px;border:1px solid #ddd" />
      </div>
    </div>

    <section id="productsSection" class="grid"></section>

    <hr style="margin:18px 0" />

    <section id="ordersSection" style="display:none">
      <h3>Orders</h3>
      <div id="ordersList" class="orders-list"></div>
    </section>
  </main>

  <footer>
    Built with ❤️ — place money.png (25px) and pay.mp3 in the same folder.
  </footer>

  <!-- audio -->
  <audio id="paySound" src="pay.mp3"></audio>

  <!-- modal backdrop -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal" id="modalContent"></div>
  </div>

  <script type="module">
  // ---------- Firebase setup (modular) ----------
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
  import { getDatabase, ref, push, set, onValue, get, child, update, remove } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js';
  import { getStorage, ref as sref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js';

  const firebaseConfig = {
    apiKey: "AIzaSyCOrJhv-bit0awn3mJacHbjEFnolzv0Ntw",
    authDomain: "minishop-67dbf.firebaseapp.com",
    databaseURL: "https://minishop-67dbf-default-rtdb.firebaseio.com",
    projectId: "minishop-67dbf",
    storageBucket: "minishop-67dbf.firebasestorage.app",
    messagingSenderId: "7379826226",
    appId: "1:7379826226:web:4d8f6f9cbc679cc600ae2b",
    measurementId: "G-6N23NYNRDB"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const storage = getStorage(app);

  // ---------- helpers ----------
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => Array.from(document.querySelectorAll(sel));

  const modalBackdrop = $('#modalBackdrop');
  const modalContent = $('#modalContent');

  function showModal(html){ modalContent.innerHTML = html; modalBackdrop.style.display = 'flex'; }
  function closeModal(){ modalBackdrop.style.display = 'none'; modalContent.innerHTML=''; }
  modalBackdrop.addEventListener('click', (e)=>{ if(e.target===modalBackdrop) closeModal(); });

  // ---------- UI actions ----------
  const prodSection = $('#productsSection');
  const ordersSection = $('#ordersSection');
  const ordersList = $('#ordersList');

  document.getElementById('addProductBtn').addEventListener('click', async ()=>{
    const code = prompt('Enter admin code to add product:');
    if(code !== '555'){ alert('Wrong code'); return; }
    showAddProductModal();
  });

  document.getElementById('adminOrdersBtn').addEventListener('click', ()=>{
    const code = prompt('Enter admin code to view/handle orders:');
    if(code !== '555'){ alert('Wrong code'); return; }
    showAdminOrders();
  });

  document.getElementById('myOrdersBtn').addEventListener('click', ()=>{
    showMyOrdersPrompt();
  });

  $('#searchInput').addEventListener('input',(e)=>{ renderProducts(e.target.value); });

  // ---------- Product modal ----------
  function showAddProductModal(){
    showModal(`
      <h3>Add product (admin)</h3>
      <div class="field"><label>Title</label><input id="p_title"/></div>
      <div class="field"><label>Description</label><textarea id="p_desc"></textarea></div>
      <div class="field"><label>Price (SAR)</label><input id="p_price" type="number" min="0" step="0.01"/></div>
      <div class="field"><label>Quantity</label><input id="p_qty" type="number" min="0" value="1"/></div>
      <div class="field"><label>Photo (optional)</label><input id="p_file" type="file" accept="image/*"/></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
        <button class="btn secondary" id="cancelAdd">Cancel</button>
        <button class="btn" id="saveAdd">Save product</button>
      </div>
    `);

    $('#cancelAdd').addEventListener('click', closeModal);
    $('#saveAdd').addEventListener('click', async ()=>{
      const title = $('#p_title').value.trim();
      const desc = $('#p_desc').value.trim();
      const price = parseFloat($('#p_price').value)||0;
      const qty = parseInt($('#p_qty').value)||0;
      const fileInput = $('#p_file');

      if(!title){ alert('Title required'); return; }

      const prodRef = push(ref(db, 'products'));
      const id = prodRef.key;
      const createdAt = Date.now();
      let imageUrl = '';

      if(fileInput.files.length>0){
        const file = fileInput.files[0];
        const storageRef = sref(storage, `products/${Date.now()}_${file.name}`);
        try{
          await uploadBytes(storageRef, file);
          imageUrl = await getDownloadURL(storageRef);
        }catch(err){
          console.error('Storage upload failed',err);
          alert('Image upload failed. Make sure your Firebase Storage rules/CORS allow uploads.');
        }
      }

      await set(prodRef, { id, title, desc, price, qty, imageUrl, createdAt });
      closeModal();
      loadProducts();
    });
  }

  // ---------- render products ----------
  let productsCache = {};
  function renderProducts(filter=''){
    prodSection.innerHTML = '';
    const arr = Object.values(productsCache)
      .filter(p=>p && p.title && p.title.toLowerCase().includes(filter.toLowerCase()));
    if(arr.length===0){ prodSection.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:var(--muted)">No products</div>'; return; }
    arr.forEach(p=>{
      const el = document.createElement('div'); el.className='card';
      el.innerHTML = `
        <img src="${p.imageUrl||'https://via.placeholder.com/400x300?text=No+Image'}" alt="${escapeHtml(p.title)}"/>
        <div style="margin-top:8px">
          <div style="font-weight:700">${escapeHtml(p.title)}</div>
          <div class="small">${escapeHtml(p.desc||'')}</div>
        </div>
        <div class="meta">
          <div class="price">${Number(p.price).toFixed(2)} SAR</div>
          <div class="chip">Qty: ${p.qty||0}</div>
        </div>
        <div style="display:flex;gap:8px;margin-top:10px">
          <button class="btn" data-id="${p.id}" ${p.qty<=0? 'disabled':''}>Buy</button>
          <button class="btn secondary" data-edit="${p.id}">Edit</button>
        </div>
      `;
      prodSection.appendChild(el);

      el.querySelector('[data-id]')?.addEventListener('click', ()=>{ promptBuy(p); });
      el.querySelector('[data-edit]')?.addEventListener('click', ()=>{ promptEdit(p); });
    });
  }

  function escapeHtml(s){ return (s+'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

  // ---------- load products from firebase ----------
  function loadProducts(){
    const productsRef = ref(db, 'products');
    onValue(productsRef, (snapshot)=>{
      productsCache = snapshot.val() || {};
      renderProducts($('#searchInput').value||'');
    });
  }
  loadProducts();

  // ---------- edit product (admin) ----------
  function promptEdit(p){
    const code = prompt('Enter admin code to edit product:');
    if(code !== '555'){ alert('Wrong code'); return; }
    showModal(`
      <h3>Edit product</h3>
      <div class="field"><label>Title</label><input id="e_title" value="${escapeHtml(p.title)}"/></div>
      <div class="field"><label>Description</label><textarea id="e_desc">${escapeHtml(p.desc||'')}</textarea></div>
      <div class="field"><label>Price (SAR)</label><input id="e_price" type="number" min="0" step="0.01" value="${p.price||0}"/></div>
      <div class="field"><label>Quantity</label><input id="e_qty" type="number" min="0" value="${p.qty||0}"/></div>
      <div class="field"><label>Replace Photo (optional)</label><input id="e_file" type="file" accept="image/*"/></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
        <button class="btn secondary" id="cancelEdit">Cancel</button>
        <button class="btn" id="saveEdit">Save</button>
      </div>
    `);

    $('#cancelEdit').addEventListener('click', closeModal);
    $('#saveEdit').addEventListener('click', async ()=>{
      const title = $('#e_title').value.trim();
      const desc = $('#e_desc').value.trim();
      const price = parseFloat($('#e_price').value)||0;
      const qty = parseInt($('#e_qty').value)||0;
      const fileInput = $('#e_file');

      let imageUrl = p.imageUrl||'';
      if(fileInput.files.length>0){
        const file = fileInput.files[0];
        const storageRef = sref(storage, `products/${Date.now()}_${file.name}`);
        try{ await uploadBytes(storageRef, file); imageUrl = await getDownloadURL(storageRef); }
        catch(err){ console.error(err); alert('Image upload failed'); }
      }

      const updates = { title, desc, price, qty, imageUrl };
      await update(ref(db, `products/${p.id}`), updates);
      closeModal();
    });
  }

  // ---------- buy flow (no login) ----------
  async function promptBuy(p){
    showModal(`
      <h3>Buy: ${escapeHtml(p.title)}</h3>
      <div class="small">Price: ${Number(p.price).toFixed(2)} SAR</div>
      <div class="field"><label>Your name</label><input id="b_name" placeholder="Enter your name"/></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
        <button class="btn secondary" id="cancelBuy">Cancel</button>
        <button class="btn" id="confirmBuy">Order</button>
      </div>
    `);

    $('#cancelBuy').addEventListener('click', closeModal);
    $('#confirmBuy').addEventListener('click', async ()=>{
      const buyer = $('#b_name').value.trim();
      if(!buyer){ alert('Name required'); return; }

      // decrement product qty atomically (simple approach)
      const prodRef = ref(db, `products/${p.id}`);
      const snapshot = await get(prodRef);
      const prodNow = snapshot.val();
      if(!prodNow || (prodNow.qty||0) <= 0){ alert('Product out of stock'); closeModal(); loadProducts(); return; }

      const newQty = (prodNow.qty||0) - 1;
      await update(prodRef, { qty: newQty });

      // create order
      const orderRef = push(ref(db, 'orders'));
      const orderId = orderRef.key;
      const order = {
        id: orderId,
        productId: p.id,
        productTitle: p.title,
        buyerName: buyer,
        price: p.price,
        status: 'pending',
        createdAt: Date.now()
      };
      await set(orderRef, order);

      // play sound
      try{ document.getElementById('paySound').play(); }catch(e){ console.warn('play failed',e); }

      alert('Order placed! Order ID: ' + orderId);
      closeModal();
      loadOrdersForBuyer(buyer);
    });
  }

  // ---------- orders UI ----------
  let allOrdersCache = {};

  function watchOrders(){
    const ordersRef = ref(db, 'orders');
    onValue(ordersRef, (snap)=>{ allOrdersCache = snap.val()||{}; });
  }
  watchOrders();

  function showAdminOrders(){
    ordersSection.style.display = 'block';
    ordersList.innerHTML = '';
    const arr = Object.values(allOrdersCache).sort((a,b)=> (b.createdAt||0)-(a.createdAt||0));
    if(arr.length===0) ordersList.innerHTML = '<div class="small">No orders</div>';
    arr.forEach(o=>{
      const row = document.createElement('div'); row.className='order-row';
      row.innerHTML = `
        <div>
          <div style="font-weight:700">${escapeHtml(o.productTitle)} — ${escapeHtml(o.buyerName)}</div>
          <div class="small">Order ID: ${o.id} • ${o.price?.toFixed?.(2)||o.price} SAR • Status: ${escapeHtml(o.status||'pending')}</div>
        </div>
        <div class="actions">
          <button class="btn" data-accept="${o.id}">Accept</button>
          <button class="btn secondary" data-cancel="${o.id}">Cancel</button>
          <button class="btn secondary" data-print="${o.id}">Print</button>
        </div>
      `;
      ordersList.appendChild(row);

      row.querySelector('[data-accept]')?.addEventListener('click', ()=>handleAccept(o));
      row.querySelector('[data-cancel]')?.addEventListener('click', ()=>handleCancel(o));
      row.querySelector('[data-print]')?.addEventListener('click', ()=>printOrder(o));
    });
  }

  async function handleAccept(o){
    if(o.status==='accepted'){ alert('Already accepted'); return; }
    await update(ref(db, `orders/${o.id}`), { status: 'accepted' });
    alert('Order accepted');
    showAdminOrders();
  }

  async function handleCancel(o){
    if(!confirm('Cancel this order?')) return;
    // restore qty
    const prodRef = ref(db, `products/${o.productId}`);
    const snap = await get(prodRef);
    const p = snap.val();
    const newQty = (p?.qty||0) + 1;
    await update(prodRef, { qty: newQty });
    await update(ref(db, `orders/${o.id}`), { status: 'cancelled' });
    alert('Order cancelled and stock restored');
    showAdminOrders();
  }

  function printOrder(o){
    const w = window.open('', '_blank');
    const html = `
      <html><head><title>Order ${o.id}</title></head><body style="font-family:Arial;padding:20px">
      <h2>Order #${o.id}</h2>
      <p><strong>Product:</strong> ${escapeHtml(o.productTitle)}</p>
      <p><strong>Buyer:</strong> ${escapeHtml(o.buyerName)}</p>
      <p><strong>Price:</strong> ${o.price?.toFixed?.(2)||o.price} SAR</p>
      <p><strong>Status:</strong> ${escapeHtml(o.status)}</p>
      <hr/>
      <p style="font-size:12px;color:#666">Printed: ${new Date(o.createdAt||Date.now()).toLocaleString()}</p>
      </body></html>
    `;
    w.document.write(html); w.document.close(); w.print();
  }

  // ---------- My orders (buyer) ----------
  function showMyOrdersPrompt(){
    showModal(`
      <h3>My Orders</h3>
      <div class="field"><label>Your name</label><input id="mo_name" placeholder="Enter the name you used when ordering"/></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
        <button class="btn secondary" id="cancelMo">Cancel</button>
        <button class="btn" id="viewMo">View</button>
      </div>
    `);
    $('#cancelMo').addEventListener('click', closeModal);
    $('#viewMo').addEventListener('click', ()=>{
      const name = $('#mo_name').value.trim(); if(!name){ alert('Name required'); return; }
      closeModal(); loadOrdersForBuyer(name);
    });
  }

  function loadOrdersForBuyer(name){
    ordersSection.style.display = 'block';
    ordersList.innerHTML = '';
    const arr = Object.values(allOrdersCache).filter(o=> o.buyerName === name ).sort((a,b)=> (b.createdAt||0)-(a.createdAt||0));
    if(arr.length===0) ordersList.innerHTML = '<div class="small">No orders for this name</div>';
    arr.forEach(o=>{
      const row = document.createElement('div'); row.className='order-row';
      row.innerHTML = `
        <div>
          <div style="font-weight:700">${escapeHtml(o.productTitle)}</div>
          <div class="small">Order ID: ${o.id} • ${o.price?.toFixed?.(2)||o.price} SAR • Status: ${escapeHtml(o.status||'pending')}</div>
        </div>
        <div class="actions">
          <button class="btn secondary" data-print="${o.id}">Print</button>
          <button class="btn secondary" data-cancel="${o.id}">Cancel</button>
        </div>
      `;
      ordersList.appendChild(row);
      row.querySelector('[data-print]')?.addEventListener('click', ()=>printOrder(o));
      row.querySelector('[data-cancel]')?.addEventListener('click', ()=>cancelByBuyer(o, name));
    });
  }

  async function cancelByBuyer(o, name){
    if(o.buyerName !== name){ alert('You can only cancel your own orders'); return; }
    if(confirm('Cancel this order?')){
      // restore qty
      const prodRef = ref(db, `products/${o.productId}`);
      const snap = await get(prodRef);
      const p = snap.val();
      const newQty = (p?.qty||0) + 1;
      await update(prodRef, { qty: newQty });
      await update(ref(db, `orders/${o.id}`), { status: 'cancelled' });
      alert('Order cancelled');
      loadOrdersForBuyer(name);
    }
  }

  // ---------- initial load ----------
  setTimeout(()=>{ loadProducts(); watchOrders(); }, 300);

  </script>
</body>
</html>
