<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>MiniShop — Realtime DB Version</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#f6f7fb;color:#111}
    header{background:#0b5cff;color:#fff;padding:12px 16px;display:flex;align-items:center;gap:12px}
    header a, header button{color:#fff;text-decoration:none}
    .container{max-width:1000px;margin:20px auto;padding:0 12px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
    .card{background:#fff;border-radius:8px;padding:12px;box-shadow:0 2px 6px rgba(0,0,0,.06)}
    img.prod{width:100%;height:160px;object-fit:cover;border-radius:6px}
    .small{font-size:.9rem;color:#555}
    .btn{background:#0b5cff;color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer}
    .btn-red{background:#c62828}
    .secondary{background:#e6eefc;color:#0b5cff}
    input,textarea{width:100%;padding:8px;border-radius:6px;border:1px solid #dfe6ee}
    .row{display:flex;gap:8px;align-items:center}
    .hidden{display:none}
    .error{color:#b00000}
    footer{padding:16px;text-align:center;color:#666}
    .placeholder{width:100%;height:160px;border-radius:6px;background:#e9eef8;display:flex;align-items:center;justify-content:center;color:#6b7a9a}
    nav a{margin-right:8px}
  </style>
</head>
<body>
  <header>
    <strong>MiniShop</strong>
    <nav style="margin-left:12px">
      <a href="#" id="nav-home">Home</a>
      <a href="#" id="nav-add">Add Product</a>
      <a href="#" id="nav-myorders">My Orders</a>
      <a href="#" id="nav-adminorders">Orders (Admin)</a>
    </nav>
    <div style="margin-left:auto" id="auth-area"></div>
  </header>

  <div class="container">
    <!-- HOME -->
    <div id="view-home">
      <div class="row" style="align-items:center;margin-bottom:12px">
        <div id="welcome" class="small"></div>
        <div style="margin-left:auto">
          <button class="btn" id="btn-refresh">Refresh</button>
          <button class="secondary btn" id="btn-login-view">Login</button>
        </div>
      </div>
      <h2>Products</h2>
      <div id="products" class="grid"></div>
    </div>

    <!-- LOGIN -->
    <div id="view-login" class="card hidden">
      <h3>Login</h3>
      <div id="login-error" class="error"></div>
      <label>First name (login):</label><input id="login-first" />
      <label>Password:</label><input id="login-pass" type="password" />
      <label><input type="checkbox" id="login-keep" /> Keep me signed in</label>
      <div style="margin-top:8px">
        <button class="btn" id="btn-login">Login</button>
        <button class="secondary btn" id="btn-show-register">Create account</button>
      </div>
      <p class="small">Login uses first name + password (under the hood we create email = first@minishop.local)</p>
    </div>

    <!-- REGISTER -->
    <div id="view-register" class="card hidden">
      <h3>Create account</h3>
      <div id="register-error" class="error"></div>
      <label>First name:</label><input id="reg-first" />
      <label>Father name:</label><input id="reg-father" />
      <label>Password:</label><input id="reg-pass" type="password" />
      <div style="margin-top:8px">
        <button class="btn" id="btn-register">Create account</button>
        <button class="secondary btn" id="btn-show-login">Back to login</button>
      </div>
    </div>

    <!-- ADD PRODUCT -->
    <div id="view-add" class="card hidden">
      <h3>Add Product (admin)</h3>
      <div id="add-error" class="error"></div>
      <div id="admin-code-box" class="small">Enter admin code to unlock product form (code not shown in UI)</div>
      <input id="admin-code-input" placeholder="Admin code" style="margin-top:6px" />
      <button class="btn" id="btn-enter-admin" style="margin-top:6px">Enter Admin Code</button>

      <div id="add-form" class="hidden" style="margin-top:12px">
        <label>Product name:</label><input id="prod-name" />
        <label>Description:</label><textarea id="prod-desc"></textarea>
        <label>Price (USD):</label><input id="prod-price" type="number" step="0.01" />
        <label>Photo (choose a file):</label><input id="prod-photo" type="file" accept="image/*" />
        <div style="margin-top:8px">
          <button class="btn" id="btn-add-product">Add product</button>
        </div>
      </div>
    </div>

    <!-- PRODUCT DETAILS (more) -->
    <div id="view-product" class="card hidden"></div>

    <!-- MY ORDERS -->
    <div id="view-myorders" class="card hidden">
      <h3>My Orders</h3>
      <div id="my-orders-list"></div>
    </div>

    <!-- ADMIN ORDERS -->
    <div id="view-adminorders" class="card hidden">
      <h3>All Orders (Admin)</h3>
      <div id="admin-orders-list"></div>
    </div>

  </div>

  <footer><small>MiniShop demo — data saved in your Firebase project (Realtime DB + Storage)</small></footer>

  <!-- Firebase modular SDK -->
  <script type="module">
    // --- CONFIG ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut,
      onAuthStateChanged,
      setPersistence,
      browserLocalPersistence,
      browserSessionPersistence,
      getIdTokenResult
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import {
      getDatabase,
      ref,
      set,
      push,
      onValue,
      get,
      remove,
      child,
      update,
      query,
      orderByChild
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import {
      getStorage,
      ref as sref,
      uploadBytes,
      getDownloadURL,
      deleteObject
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCOrJhv-bit0awn3mJacHbjEFnolzv0Ntw",
      authDomain: "minishop-67dbf.firebaseapp.com",
      databaseURL: "https://minishop-67dbf-default-rtdb.firebaseio.com",
      projectId: "minishop-67dbf",
      storageBucket: "minishop-67dbf.appspot.com",
      messagingSenderId: "7379826226",
      appId: "1:7379826226:web:4d8f6f9cbc679cc600ae2b",
      measurementId: "G-6N23NYNRDB"
    };

    // initialize
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const storage = getStorage(app);

    // ---------- small config / secret (not in HTML UI) ----------
    // NOTE: This is the admin code. It's kept in JS only (not displayed in UI).
    // If you need to change it, edit this value.
    const ADMIN_CODE = '555';

    // ---------- DOM refs ----------
    const views = {
      home: document.getElementById('view-home'),
      login: document.getElementById('view-login'),
      register: document.getElementById('view-register'),
      add: document.getElementById('view-add'),
      product: document.getElementById('view-product'),
      myorders: document.getElementById('view-myorders'),
      adminorders: document.getElementById('view-adminorders')
    };
    function showView(viewEl) {
      Object.values(views).forEach(v => v.classList.add('hidden'));
      viewEl.classList.remove('hidden');
      window.scrollTo(0,0);
    }

    // nav links
    document.getElementById('nav-home').onclick = (e)=>{ e.preventDefault(); showView(views.home); loadProducts(); };
    document.getElementById('nav-add').onclick = (e)=>{ e.preventDefault(); showView(views.add); };
    document.getElementById('nav-myorders').onclick = (e)=>{ e.preventDefault(); showView(views.myorders); loadMyOrders(); };
    document.getElementById('nav-adminorders').onclick = (e)=>{ e.preventDefault(); showView(views.adminorders); loadAdminOrders(); };

    // auth UI area
    const authArea = document.getElementById('auth-area');
    function renderAuthArea(profile, signedIn) {
      authArea.innerHTML = '';
      if (!signedIn) {
        const lbtn = document.createElement('button'); lbtn.textContent='Login'; lbtn.className='btn'; lbtn.onclick = ()=> showView(views.login);
        const rbtn = document.createElement('button'); rbtn.textContent='Register'; rbtn.className='secondary btn'; rbtn.onclick = ()=> showView(views.register);
        authArea.appendChild(lbtn); authArea.appendChild(document.createTextNode(' ')); authArea.appendChild(rbtn);
        document.getElementById('welcome').textContent = '';
      } else {
        const span = document.createElement('span'); span.textContent = `Hi, ${profile.firstName}`;
        authArea.appendChild(span);
        authArea.appendChild(document.createTextNode(' '));
        const logout = document.createElement('button'); logout.textContent='Logout'; logout.className='btn';
        logout.onclick = async ()=> { try { await signOut(auth); } catch(e){ console.error(e); } };
        authArea.appendChild(logout);
        document.getElementById('welcome').textContent = `Signed in as ${profile.firstName} ${profile.fatherName || ''}`;
      }
    }

    // ---------- Auth: register / login ----------
    document.getElementById('btn-show-login').onclick = ()=> showView(views.login);
    document.getElementById('btn-show-register').onclick = ()=> showView(views.register);

    document.getElementById('btn-register').onclick = async () => {
      const first = document.getElementById('reg-first').value.trim();
      const father = document.getElementById('reg-father').value.trim();
      const pass = document.getElementById('reg-pass').value;
      const err = document.getElementById('register-error');
      err.textContent = '';
      if (!first || !father || !pass) { err.textContent = 'All fields required.'; return; }
      try {
        const email = `${first.toLowerCase()}@minishop.local`;
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        // Save user profile into Realtime DB
        await set(ref(db, `users/${cred.user.uid}`), {
          firstName: first,
          fatherName: father
        });
        // show home
        showView(views.home);
      } catch (e) {
        console.error('register error', e);
        if (e.code === 'auth/configuration-not-found') {
          err.innerHTML = 'Firebase Auth Email/Password not enabled. Open Firebase Console → Authentication → Sign-in method and enable Email/Password.';
        } else {
          err.textContent = e.message || 'Could not create account.';
        }
      }
    };

    document.getElementById('btn-login').onclick = async () => {
      const first = document.getElementById('login-first').value.trim();
      const pass = document.getElementById('login-pass').value;
      const keep = document.getElementById('login-keep').checked;
      const err = document.getElementById('login-error');
      err.textContent = '';
      if (!first || !pass) { err.textContent = 'Name and password required.'; return; }
      try {
        if (keep) await setPersistence(auth, browserLocalPersistence); else await setPersistence(auth, browserSessionPersistence);
        const email = `${first.toLowerCase()}@minishop.local`;
        await signInWithEmailAndPassword(auth, email, pass);
        showView(views.home);
      } catch (e) {
        console.error('login error', e);
        if (e.code === 'auth/configuration-not-found') {
          err.innerHTML = 'Firebase Auth Email/Password not enabled. Open Firebase Console → Authentication → Sign-in method and enable Email/Password.';
        } else {
          err.textContent = 'Invalid name or password.';
        }
      }
    };

    // ---------- Admin code entry (client-side) ----------
    let isAdminLocal = false; // toggles admin UI
    document.getElementById('btn-enter-admin').onclick = () => {
      const code = document.getElementById('admin-code-input').value.trim();
      if (code === ADMIN_CODE) {
        isAdminLocal = true;
        document.getElementById('admin-code-input').value = '';
        document.getElementById('add-error').textContent = 'Admin unlocked (client-side).';
        document.getElementById('add-form').classList.remove('hidden');
        document.getElementById('admin-code-box').classList.add('hidden');
      } else {
        document.getElementById('add-error').textContent = 'Incorrect admin code.';
      }
    };

    // ---------- Products: add, list, more, delete ----------
    async function uploadFileAndGetURL(file) {
      const path = `products/${Date.now()}-${file.name}`;
      const sRef = sref(storage, path);
      await uploadBytes(sRef, file);
      const url = await getDownloadURL(sRef);
      return { url, path };
    }

    document.getElementById('btn-add-product').onclick = async () => {
      const name = document.getElementById('prod-name').value.trim();
      const desc = document.getElementById('prod-desc').value.trim();
      const price = parseFloat(document.getElementById('prod-price').value);
      const fileEl = document.getElementById('prod-photo');
      const err = document.getElementById('add-error'); err.textContent = '';
      if (!isAdminLocal) { err.textContent = 'Admin required (enter admin code first).'; return; }
      if (!name || isNaN(price) || !fileEl.files[0]) { err.textContent = 'Name, price and photo required.'; return; }
      try {
        const file = fileEl.files[0];
        const { url, path } = await uploadFileAndGetURL(file);
        const pRef = push(ref(db, 'products'));
        await set(pRef, {
          name, description: desc, price: price, imageUrl: url, imagePath: path,
          createdAt: Date.now()
        });
        // Clear form
        document.getElementById('prod-name').value='';
        document.getElementById('prod-desc').value='';
        document.getElementById('prod-price').value='';
        fileEl.value='';
        loadProducts();
        alert('Product added');
      } catch (e) {
        console.error('add product err', e);
        err.textContent = 'Could not upload product. Check Storage rules and that you are admin (client-side).';
      }
    };

    // Listen / load products
    const productsNode = ref(db, 'products');
    async function loadProducts() {
      const container = document.getElementById('products');
      container.innerHTML = 'Loading...';
      try {
        onValue(productsNode, snapshot => {
          container.innerHTML = '';
          if (!snapshot.exists()) { container.innerHTML = '<div class="card">No products yet.</div>'; return; }
          const items = [];
          snapshot.forEach(childSnap => {
            const p = childSnap.val(); p._id = childSnap.key; items.push(p);
          });
          // newest first
          items.sort((a,b)=> (b.createdAt||0) - (a.createdAt||0));
          items.forEach(p => {
            const card = document.createElement('div'); card.className='card';
            if (p.imageUrl) {
              const img = document.createElement('img'); img.className='prod'; img.src = p.imageUrl; card.appendChild(img);
            } else {
              const ph = document.createElement('div'); ph.className='placeholder'; ph.textContent='No photo'; card.appendChild(ph);
            }
            const h = document.createElement('h4'); h.textContent = p.name; card.appendChild(h);
            const d = document.createElement('p'); d.className='small'; d.textContent = p.description || ''; card.appendChild(d);
            const pr = document.createElement('p'); pr.innerHTML = `<strong>Price:</strong> $${parseFloat(p.price||0).toFixed(2)}`; card.appendChild(pr);
            const row = document.createElement('div'); row.className='row';
            const more = document.createElement('button'); more.className='btn'; more.textContent='More'; more.onclick = ()=> showProduct(p._id); row.appendChild(more);
            if (auth.currentUser) {
              const ord = document.createElement('button'); ord.className='secondary btn'; ord.textContent='Order'; ord.onclick = ()=> placeOrder(p._id); row.appendChild(ord);
            } else {
              const loginLink = document.createElement('a'); loginLink.href='#'; loginLink.textContent='Login to order'; loginLink.onclick = (e)=>{ e.preventDefault(); showView(views.login); }; row.appendChild(loginLink);
            }
            if (isAdminLocal) {
              const del = document.createElement('button'); del.className='btn btn-red'; del.textContent='Delete'; del.onclick = ()=> deleteProduct(p._id, p.imagePath); row.appendChild(del);
            }
            card.appendChild(row);
            container.appendChild(card);
          });
        }, { onlyOnce: false });
      } catch (e) {
        console.error('loadProducts error', e);
        container.innerHTML = '<div class="card">Could not load products.</div>';
      }
    }

    // Show product details
    async function showProduct(productId) {
      try {
        const snap = await get(child(ref(db), `products/${productId}`));
        if (!snap.exists()) return alert('Product not found.');
        const p = snap.val(); p._id = productId;
        const view = document.getElementById('view-product');
        view.innerHTML = '';
        const c = document.createElement('div'); c.className='card';
        const h = document.createElement('h3'); h.textContent = p.name; c.appendChild(h);
        if (p.imageUrl) {
          const img = document.createElement('img'); img.className='prod'; img.src = p.imageUrl; c.appendChild(img);
        } else {
          const ph = document.createElement('div'); ph.className='placeholder'; ph.textContent='No photo'; c.appendChild(ph);
        }
        const desc = document.createElement('p'); desc.textContent = p.description || ''; c.appendChild(desc);
        const price = document.createElement('p'); price.innerHTML = `<strong>Price:</strong> $${parseFloat(p.price||0).toFixed(2)}`; c.appendChild(price);
        const row = document.createElement('div'); row.className='row';
        if (auth.currentUser) {
          const ord = document.createElement('button'); ord.className='btn'; ord.textContent='Order'; ord.onclick = ()=> placeOrder(p._id); row.appendChild(ord);
        } else {
          const a = document.createElement('a'); a.href='#'; a.textContent='Login to order'; a.onclick = (e)=>{ e.preventDefault(); showView(views.login); }; row.appendChild(a);
        }
        c.appendChild(row);
        view.appendChild(c);
        showView(views.product);
      } catch (e) {
        console.error('showProduct', e);
        alert('Could not load product.');
      }
    }

    // Delete product (admin)
    async function deleteProduct(productId, imagePath) {
      if (!confirm('Delete product?')) return;
      if (!isAdminLocal) return alert('Admin only.');
      try {
        // delete storage image
        if (imagePath) {
          try { await deleteObject(sref(storage, imagePath)); } catch(err){ /* ignore if missing */ }
        }
        await remove(ref(db, `products/${productId}`));
        alert('Product deleted.');
      } catch (e) {
        console.error('deleteProduct', e);
        alert('Could not delete product.');
      }
    }

    // ---------- Orders: place, my orders, admin orders ----------
    async function placeOrder(productId) {
      if (!auth.currentUser) { showView(views.login); return; }
      try {
        // snapshot product
        const pSnap = await get(child(ref(db), `products/${productId}`));
        if (!pSnap.exists()) return alert('Product not found');
        const p = pSnap.val();
        const userSnap = await get(child(ref(db), `users/${auth.currentUser.uid}`));
        const user = userSnap.exists() ? userSnap.val() : { firstName:'', fatherName:'' };
        const oRef = push(ref(db, 'orders'));
        await set(oRef, {
          userId: auth.currentUser.uid,
          userFirstName: user.firstName || '',
          userFatherName: user.fatherName || '',
          productId,
          productName: p.name || '',
          productPrice: p.price || 0,
          productImage: p.imageUrl || '',
          status: 'Pending',
          createdAt: Date.now()
        });
        alert('Order placed');
        showView(views.myorders);
        loadMyOrders();
      } catch (e) {
        console.error('placeOrder', e);
        alert('Could not place order.');
      }
    }

    async function loadMyOrders() {
      if (!auth.currentUser) { showView(views.login); return; }
      try {
        const ordersRef = ref(db, 'orders');
        onValue(ordersRef, snapshot => {
          const out = document.getElementById('my-orders-list');
          out.innerHTML = '';
          if (!snapshot.exists()) { out.innerHTML = '<div class="card">No orders.</div>'; return; }
          const arr = [];
          snapshot.forEach(childSnap => {
            const o = childSnap.val(); o._id = childSnap.key;
            if (o.userId === auth.currentUser.uid) arr.push(o);
          });
          arr.sort((a,b)=> (b.createdAt||0)-(a.createdAt||0));
          if (arr.length === 0) out.innerHTML = '<div class="card">You have no orders.</div>';
          arr.forEach(o => {
            const c = document.createElement('div'); c.className='card';
            const h = document.createElement('h4'); h.textContent = o.productName; c.appendChild(h);
            const s = document.createElement('p'); s.innerHTML = `<strong>Status:</strong> ${o.status}`; c.appendChild(s);
            const t = document.createElement('p'); t.className='small'; t.textContent = `Ordered at: ${new Date(o.createdAt).toLocaleString()}`; c.appendChild(t);
            if (o.productImage) { const img = document.createElement('img'); img.src = o.productImage; img.className='prod'; img.style.height='120px'; c.appendChild(img); }
            if (o.status !== 'Delivered') {
              const cancel = document.createElement('button'); cancel.className='btn'; cancel.textContent='Cancel'; cancel.onclick = async ()=>{
                if (!confirm('Cancel order?')) return;
                try { await remove(ref(db, `orders/${o._id}`)); loadMyOrders(); } catch(e){ console.error(e); alert('Could not cancel'); }
              };
              c.appendChild(cancel);
            }
            out.appendChild(c);
          });
        }, { onlyOnce: false });
      } catch (e) {
        console.error('loadMyOrders', e);
        document.getElementById('my-orders-list').innerHTML = '<div class="card">Could not load orders.</div>';
      }
    }

    async function loadAdminOrders() {
      if (!isAdminLocal) {
        document.getElementById('admin-orders-list').innerHTML = '<div class="card">Admin only. Enter admin code on Add Product page.</div>';
        return;
      }
      try {
        const ordersRef = ref(db, 'orders');
        onValue(ordersRef, snapshot => {
          const out = document.getElementById('admin-orders-list');
          out.innerHTML = '';
          if (!snapshot.exists()) { out.innerHTML = '<div class="card">No orders.</div>'; return; }
          const arr = [];
          snapshot.forEach(childSnap => {
            const o = childSnap.val(); o._id = childSnap.key; arr.push(o);
          });
          arr.sort((a,b)=> (b.createdAt||0)-(a.createdAt||0));
          arr.forEach(o => {
            const c = document.createElement('div'); c.className='card';
            const h = document.createElement('h4'); h.textContent = o.productName; c.appendChild(h);
            const by = document.createElement('p'); by.className='small'; by.textContent = `Ordered by: ${o.userFirstName} ${o.userFatherName}`; c.appendChild(by);
            const s = document.createElement('p'); s.innerHTML = `<strong>Status:</strong> ${o.status}`; c.appendChild(s);
            const t = document.createElement('p'); t.className='small'; t.textContent = `At: ${new Date(o.createdAt).toLocaleString()}`; c.appendChild(t);
            const row = document.createElement('div'); row.className='row';
            ['Declined','Accepted','Delivered'].forEach(st => {
              const b = document.createElement('button'); b.className='btn'; b.textContent = st;
              b.onclick = async () => {
                try { await update(ref(db, `orders/${o._id}`), { status: st }); loadAdminOrders(); } catch(e){ console.error(e); alert('Could not update'); }
              };
              row.appendChild(b);
            });
            c.appendChild(row);
            out.appendChild(c);
          });
        }, { onlyOnce: false });
      } catch (e) {
        console.error('loadAdminOrders', e);
        document.getElementById('admin-orders-list').innerHTML = '<div class="card">Could not load admin orders.</div>';
      }
    }

    // ---------- Auth state monitoring ----------
    let currentProfile = null;
    onAuthStateChanged(auth, async user => {
      if (user) {
        // get user profile from DB
        try {
          const uSnap = await get(child(ref(db), `users/${user.uid}`));
          const profile = uSnap.exists() ? uSnap.val() : { firstName: '', fatherName: '' };
          currentProfile = { firstName: profile.firstName || '', fatherName: profile.fatherName || '' };
          renderAuthArea(currentProfile, true);
        } catch (e) {
          console.error('get profile', e);
          renderAuthArea({ firstName: '' }, true);
        }
      } else {
        currentProfile = null;
        renderAuthArea(null, false);
      }
      // refresh products view (some controls require auth state)
      loadProducts();
    });

    // initial load
    document.getElementById('btn-refresh').onclick = loadProducts;
    loadProducts();

    // helper: shortcut for get(child(...))
    async function getNode(path) { return get(child(ref(db), path)); }

  </script>
</body>
</html>