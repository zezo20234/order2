<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>MiniShop (Realtime DB Only)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:Arial;margin:0;background:#f4f6fb}
header{background:#1e5bff;color:#fff;padding:12px;display:flex;align-items:center}
header button{margin-left:6px}
.container{max-width:1000px;margin:auto;padding:12px}
.card{background:#fff;padding:12px;margin-bottom:12px;border-radius:6px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:10px}
img{width:100%;border-radius:6px}
button{padding:6px 10px;border:none;border-radius:4px;background:#1e5bff;color:#fff;cursor:pointer}
.red{background:#c62828}
input,textarea{width:100%;padding:6px;margin:4px 0}
.hidden{display:none}
.small{font-size:13px;color:#555}
</style>
</head>
<body>

<header>
<b>MiniShop</b>
<div style="margin-left:auto" id="topButtons"></div>
</header>

<div class="container">

<!-- LOGIN -->
<div id="loginView" class="card">
<h3>Login</h3>
<input id="loginName" placeholder="First name">
<input id="loginPass" type="password" placeholder="Password">
<label><input type="checkbox" id="keepLogin"> Keep me signed in</label><br><br>
<button onclick="login()">Login</button>
<button onclick="showRegister()">Create account</button>
<div id="loginMsg" class="small"></div>
</div>

<!-- REGISTER -->
<div id="registerView" class="card hidden">
<h3>Create Account</h3>
<input id="regFirst" placeholder="First name">
<input id="regFather" placeholder="Father name">
<input id="regPass" type="password" placeholder="Password">
<button onclick="register()">Create</button>
<button onclick="showLogin()">Back</button>
<div id="regMsg" class="small"></div>
</div>

<!-- HOME -->
<div id="homeView" class="hidden">
<h3>Products</h3>
<button onclick="showAddProduct()">Add Product</button>
<div id="products" class="grid"></div>
</div>

<!-- ADD PRODUCT -->
<div id="addProductView" class="card hidden">
<h3>Add Product (Admin)</h3>
<input id="adminCode" placeholder="Admin code">
<button onclick="unlockAdmin()">Unlock</button>

<div id="productForm" class="hidden">
<input id="pName" placeholder="Name">
<textarea id="pDesc" placeholder="Description"></textarea>
<input id="pPrice" type="number" placeholder="Price">
<input id="pImage" type="file">
<button onclick="addProduct()">Add</button>
</div>
</div>

<!-- MY ORDERS -->
<div id="ordersView" class="card hidden">
<h3>My Orders</h3>
<div id="myOrders"></div>
</div>

<!-- ADMIN ORDERS -->
<div id="adminOrdersView" class="card hidden">
<h3>All Orders (Admin)</h3>
<div id="adminOrders"></div>
</div>

</div>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, push, onValue, remove, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { getStorage, ref as sref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

const firebaseConfig = {
 apiKey: "AIzaSyCOrJhv-bit0awn3mJacHbjEFnolzv0Ntw",
 authDomain: "minishop-67dbf.firebaseapp.com",
 databaseURL: "https://minishop-67dbf-default-rtdb.firebaseio.com",
 projectId: "minishop-67dbf",
 storageBucket: "minishop-67dbf.appspot.com",
 messagingSenderId: "7379826226",
 appId: "1:7379826226:web:4d8f6f9cbc679cc600ae2b"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const storage = getStorage(app);

let currentUser = null;
let isAdmin = false;
const ADMIN_CODE = "555";

/* ---------- AUTH ---------- */
window.register = async () => {
 const first = regFirst.value.trim();
 const father = regFather.value.trim();
 const pass = regPass.value.trim();
 if(!first||!father||!pass) return regMsg.textContent="Fill all fields";

 const userRef = ref(db,"users/"+first.toLowerCase());
 const snap = await get(userRef);
 if(snap.exists()) return regMsg.textContent="User already exists";

 await set(userRef,{first,father,pass});
 regMsg.textContent="Account created";
 showLogin();
};

window.login = async () => {
 const name = loginName.value.trim().toLowerCase();
 const pass = loginPass.value.trim();
 const snap = await get(ref(db,"users/"+name));
 if(!snap.exists() || snap.val().pass!==pass){
  loginMsg.textContent="Wrong login";
  return;
 }
 currentUser = name;
 if(keepLogin.checked) localStorage.setItem("user",name);
 loginMsg.textContent="";
 showHome();
 loadProducts();
};

window.logout = () => {
 currentUser=null;
 isAdmin=false;
 localStorage.removeItem("user");
 location.reload();
};

/* ---------- UI ---------- */
function showLogin(){
 loginView.classList.remove("hidden");
 registerView.classList.add("hidden");
}
function showRegister(){
 loginView.classList.add("hidden");
 registerView.classList.remove("hidden");
}
function showHome(){
 loginView.classList.add("hidden");
 homeView.classList.remove("hidden");
 topButtons.innerHTML=`<button onclick="showMyOrders()">My Orders</button><button onclick="logout()">Logout</button>`;
}
window.showAddProduct=()=>addProductView.classList.remove("hidden");
window.showMyOrders=()=>{
 ordersView.classList.remove("hidden");
 loadMyOrders();
};

/* ---------- ADMIN ---------- */
window.unlockAdmin=()=>{
 if(adminCode.value===ADMIN_CODE){
  isAdmin=true;
  productForm.classList.remove("hidden");
 }
};

/* ---------- PRODUCTS ---------- */
window.addProduct=async()=>{
 if(!isAdmin) return;
 const file=pImage.files[0];
 const imgRef=sref(storage,"products/"+Date.now());
 await uploadBytes(imgRef,file);
 const url=await getDownloadURL(imgRef);

 await push(ref(db,"products"),{
  name:pName.value,
  desc:pDesc.value,
  price:pPrice.value,
  img:url
 });
 loadProducts();
};

function loadProducts(){
 onValue(ref(db,"products"),snap=>{
  products.innerHTML="";
  snap.forEach(s=>{
   const p=s.val();
   products.innerHTML+=`
   <div class="card">
    <img src="${p.img}">
    <h4>${p.name}</h4>
    <p>${p.desc}</p>
    <b>$${p.price}</b><br>
    <button onclick="orderProduct('${s.key}')">Order</button>
   </div>`;
  });
 });
}

window.orderProduct=async(id)=>{
 await push(ref(db,"orders"),{
  product:id,
  user:currentUser,
  status:"Pending"
 });
 alert("Ordered");
};

/* ---------- ORDERS ---------- */
function loadMyOrders(){
 onValue(ref(db,"orders"),snap=>{
  myOrders.innerHTML="";
  snap.forEach(s=>{
   const o=s.val();
   if(o.user===currentUser){
    myOrders.innerHTML+=`
    <div class="card">
     Order: ${o.product}<br>
     Status: ${o.status}
     <button class="red" onclick="removeOrder('${s.key}')">Cancel</button>
    </div>`;
   }
  });
 });
}
window.removeOrder=id=>remove(ref(db,"orders/"+id));

/* AUTO LOGIN */
const saved=localStorage.getItem("user");
if(saved){currentUser=saved;showHome();loadProducts();}
</script>
</body>
</html>