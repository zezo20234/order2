<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mini Shop — Updated</title>
  <meta name="theme-color" content="#0ea5a3">
  <style>
    :root{--bg:#ffffff;--card:#fff9f0;--muted:#4b5563;--accent:#ef4444;--accent2:#0ea5a3}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial;background:var(--bg);color:#0f1724}
    .container{max-width:1100px;margin:28px auto;padding:18px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{margin:0;font-size:22px}
    .controls{display:flex;align-items:center}
    .controls button{margin-left:8px;padding:8px 12px;border-radius:8px;border:0;background:var(--accent2);color:white;cursor:pointer}
    nav a{margin-right:10px;color:var(--muted);text-decoration:none}

    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:18px}

    /* Pokémon-card style */
    .pcard{background:linear-gradient(180deg,#fff,#fff7ed);border-radius:14px;border:3px solid #fde68a;box-shadow:0 12px 30px rgba(15,23,42,0.06);overflow:hidden;display:flex;flex-direction:column}
    .pcard .art{height:170px;background:linear-gradient(180deg,#f3f4f6,#e6eef6);display:flex;align-items:center;justify-content:center}
    .pcard .art img{width:100%;height:100%;object-fit:cover}
    .pcard .content{padding:12px}
    .pcard h3{margin:0 0 6px 0;font-size:16px}
    .muted{color:var(--muted);font-size:13px}
    .stats{display:flex;gap:8px;align-items:center;margin-top:8px}
    .stat{background:rgba(0,0,0,0.03);padding:6px 8px;border-radius:999px;font-weight:600;font-size:13px}
    .moneyicon{width:22px;height:22px;vertical-align:middle;margin-right:6px;border-radius:4px;} 
    .pfooter{display:flex;gap:8px;padding:12px;border-top:1px dashed rgba(15,23,36,0.04);background:linear-gradient(180deg,rgba(255,255,255,0.6),transparent)}
    .btn{padding:8px 12px;border-radius:8px;border:0;background:var(--accent2);color:#fff;cursor:pointer}
    .small{padding:6px 8px;font-size:13px}
    .danger{background:#ef4444}

    .hidden{display:none}
    .page{display:none}
    .page.active{display:block}

    .sheet{background:white;padding:16px;border-radius:12px;box-shadow:0 8px 24px rgba(2,6,23,0.06)}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:8px}

    .ticket{background:#ffffff;padding:12px;border-radius:8px;border:1px solid rgba(15,23,36,0.04);box-shadow:0 6px 18px rgba(15,23,36,0.03)}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;background:rgba(15,23,36,0.04);font-size:12px}
    .flex{display:flex;gap:8px;align-items:center}

    input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(15,23,36,0.06);background:transparent;color:inherit}

    .topbar{display:flex;gap:12px;align-items:center}
    .pill{padding:8px 12px;border-radius:999px;background:#f1f5f9;border:1px solid rgba(15,23,36,0.04)}

    .cart-count{background:#ef4444;color:#fff;padding:2px 8px;border-radius:999px;font-weight:700;margin-left:6px}

    /* tutorial modal overlay */
    .modal{position:fixed;inset:0;background:rgba(2,6,23,0.4);display:flex;align-items:center;justify-content:center;padding:20px;z-index:9999}
    .tutorial-box{width:100%;max-width:560px;padding:18px;border-radius:12px;background:white}
    .no-pointer{pointer-events:none;opacity:0.6}

    @media (max-width:520px){.pcard .art{height:120px}.form-row{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Mini Shop</h1>
        <div class="muted">Small demo shop with accounts, cart & admin</div>
      </div>
      <div class="controls">
        <nav class="topbar">
          <a href="#/" title="Home">Home</a>
          <a href="#/my-orders">My Orders</a>
          <a href="#/cart">My Cart <span id="cartCount" class="cart-count hidden">0</span></a>
          <a id="btnAddProduct" href="#/add-product">Add product</a>
          <a id="btnAdminOrders" href="#/admin-orders">Orders</a>
        </nav>
        <div style="width:12px"></div>
        <div id="userArea" style="display:flex;align-items:center;gap:8px;margin-left:12px">
          <div id="userName" class="muted"></div>
          <button id="btnLogin" class="btn small">Login</button>
          <button id="btnLogout" class="btn small hidden">Logout</button>
        </div>
      </div>
    </header>

    <!-- Pages -->
    <main>
      <section id="homePage" class="page active">
        <h2 class="muted">Products</h2>
        <div id="products" class="grid" aria-live="polite"></div>
      </section>

      <section id="addProductPage" class="page">
        <div class="sheet">
          <h3>Add product (admin)</h3>
          <div style="margin-top:8px">
            <label>Title</label>
            <input id="pTitle" placeholder="e.g. Blue Potion" />
            <label style="margin-top:8px">Description</label>
            <textarea id="pDesc" rows="3"></textarea>
            <label style="margin-top:8px">Choose image from device</label>
            <input id="pImageFile" type="file" accept="image/*" />
            <div id="uploadingNote" class="muted" style="margin-top:6px;display:none">Processing image…</div>
            <div class="form-row" style="margin-top:8px">
              <div>
                <label>Price</label>
                <input id="pPrice" type="number" min="0" />
              </div>
              <div>
                <label>Quantity</label>
                <input id="pQty" type="number" min="0" />
              </div>
            </div>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
              <button id="pCancelPage" class="btn small">Cancel</button>
              <button id="pSave" class="btn">Save product</button>
            </div>
          </div>
        </div>
      </section>

      <section id="cartPage" class="page">
        <div class="sheet">
          <h3>My Cart</h3>
          <div id="cartList" style="margin-top:12px;display:grid;gap:8px"></div>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
            <button id="clearCart" class="btn small">Clear</button>
            <button id="placeCartOrder" class="btn">Order</button>
          </div>
        </div>
      </section>

      <section id="myOrdersPage" class="page">
        <div class="sheet">
          <h3>My Orders</h3>
          <div id="myOrdersList" style="margin-top:12px;display:grid;gap:8px"></div>
        </div>
      </section>

      <section id="adminOrdersPage" class="page">
        <div class="sheet">
          <h3>All Orders (admin)</h3>
          <div id="ordersList" style="margin-top:8px;display:grid;gap:8px;max-height:60vh;overflow:auto"></div>
        </div>
      </section>

      <section id="loginPage" class="page">
        <div class="sheet">
          <h3 id="loginTitle">Login</h3>
          <div style="margin-top:8px">
            <div id="loginMsg" class="muted">Use first name and password to login</div>
            <label style="margin-top:8px">First name</label>
            <input id="loginFirst" />
            <label style="margin-top:8px">Password</label>
            <input id="loginPass" type="password" />
            <div style="display:flex;align-items:center;gap:8px;margin-top:8px"><input id="keepSignedIn" type="checkbox" /> <label for="keepSignedIn">Keep me signed in</label></div>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
              <button id="gotoRegister" class="btn small">Create account</button>
              <button id="doLogin" class="btn">Login</button>
            </div>
          </div>
        </div>
      </section>

      <section id="registerPage" class="page">
        <div class="sheet">
          <h3>Create Account</h3>
          <div style="margin-top:8px">
            <label>First name</label>
            <input id="regFirst" />
            <label style="margin-top:8px">Last name</label>
            <input id="regLast" />
            <label style="margin-top:8px">Class</label>
            <input id="regClass" />
            <label style="margin-top:8px">Password</label>
            <input id="regPass" type="password" />
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
              <button id="gotoLoginFromReg" class="btn small">Back to login</button>
              <button id="doRegister" class="btn">Create account</button>
            </div>
          </div>
        </div>
      </section>

    </main>

    <footer style="margin-top:18px;color:var(--muted);font-size:13px">Tip: Add to home screen for the best experience.</footer>
  </div>

  <!-- tutorial modal --- shows on entry and blocks close for 5s -->
  <div id="tutorialModal" class="modal hidden">
    <div class="tutorial-box">
      <h3>How to use Mini Shop</h3>
      <p class="muted">Welcome — quick tour. You can add products (admin), add items to your cart, create an account, and place orders. Admins accept/decline/deliver orders.</p>
      <ul class="muted">
        <li>To add a product or manage all orders, use the Orders/Add product links (admin code required).</li>
        <li>Your cart is stored locally. On ordering you must login or create an account.</li>
      </ul>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button id="tutorialCloseBtn" class="btn small">Close</button>
      </div>
      <div id="tutorialCountdown" class="muted" style="margin-top:8px">Please wait... 5</div>
    </div>
  </div>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    // ---------- Firebase config (from user) ----------
    const firebaseConfig = {
      apiKey: "AIzaSyCOrJhv-bit0awn3mJacHbjEFnolzv0Ntw",
      authDomain: "minishop-67dbf.firebaseapp.com",
      databaseURL: "https://minishop-67dbf-default-rtdb.firebaseio.com",
      projectId: "minishop-67dbf",
      storageBucket: "minishop-67dbf.appspot.com",
      messagingSenderId: "7379826226",
      appId: "1:7379826226:web:4d8f6f9cbc679cc600ae2b",
      measurementId: "G-6N23NYNRDB"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ---------- App state ----------
    let currentUser = null; // {id, first, last, class}
    const CART_KEY = 'mini_shop_cart_v1';

    // ---------- DOM refs ----------
    const pages = {
      home: document.getElementById('homePage'),
      add: document.getElementById('addProductPage'),
      cart: document.getElementById('cartPage'),
      myOrders: document.getElementById('myOrdersPage'),
      adminOrders: document.getElementById('adminOrdersPage'),
      login: document.getElementById('loginPage'),
      register: document.getElementById('registerPage')
    };

    const productsEl = document.getElementById('products');
    const pTitle = document.getElementById('pTitle');
    const pDesc = document.getElementById('pDesc');
    const pPrice = document.getElementById('pPrice');
    const pQty = document.getElementById('pQty');
    const pImageFile = document.getElementById('pImageFile');
    const pSave = document.getElementById('pSave');
    const pCancelPage = document.getElementById('pCancelPage');

    const cartList = document.getElementById('cartList');
    const cartCountEl = document.getElementById('cartCount');
    const placeCartOrderBtn = document.getElementById('placeCartOrder');
    const clearCartBtn = document.getElementById('clearCart');

    const myOrdersList = document.getElementById('myOrdersList');
    const ordersList = document.getElementById('ordersList');

    const btnLogin = document.getElementById('btnLogin');
    const btnLogout = document.getElementById('btnLogout');
    const userNameEl = document.getElementById('userName');

    // login/register refs
    const loginFirst = document.getElementById('loginFirst');
    const loginPass = document.getElementById('loginPass');
    const doLoginBtn = document.getElementById('doLogin');
    const gotoRegister = document.getElementById('gotoRegister');
    const regFirst = document.getElementById('regFirst');
    const regLast = document.getElementById('regLast');
    const regClass = document.getElementById('regClass');
    const regPass = document.getElementById('regPass');
    const doRegisterBtn = document.getElementById('doRegister');
    const gotoLoginFromReg = document.getElementById('gotoLoginFromReg');
    const keepSignedIn = document.getElementById('keepSignedIn');

    const tutorialModal = document.getElementById('tutorialModal');
    const tutorialCloseBtn = document.getElementById('tutorialCloseBtn');
    const tutorialCountdown = document.getElementById('tutorialCountdown');

    // Routing helpers
    function showPage(name){
      Object.values(pages).forEach(p=>p.classList.remove('active'));
      if(pages[name]) pages[name].classList.add('active');
      window.location.hash = '#/' + (name==='home'? '': name);
      if(name === 'cart') renderCart();
      if(name === 'myOrders') renderMyOrders();
      if(name === 'adminOrders') renderAdminOrders();
    }

    // Hash routing on load/changes
    function routeFromHash(){
      const h = location.hash.replace('#/','');
      if(!h) return showPage('home');
      if(h.startsWith('add-product') || h === 'add') return showPage('add');
      if(h.startsWith('cart')) return showPage('cart');
      if(h.startsWith('my-orders') || h==='my-orders') return showPage('myOrders');
      if(h.startsWith('admin-orders') || h==='admin-orders') return showPage('adminOrders');
      if(h.startsWith('login')) return showPage('login');
      if(h.startsWith('register')) return showPage('register');
      showPage('home');
    }
    window.addEventListener('hashchange', routeFromHash);

    // ---------- Tutorial modal behavior: FIXED (reliable close + 5s lock) ----------
    let tutorialLocked = false;
    let tutorialTimer = null;

    function showTutorialBlock() {
      // reset state
      if (tutorialTimer) clearInterval(tutorialTimer);
      tutorialLocked = true;

      tutorialModal.classList.remove('hidden');
      tutorialCloseBtn.disabled = false; // keep enabled so click handler always works

      let seconds = 5;
      tutorialCountdown.textContent = 'Please wait... ' + seconds;

      tutorialTimer = setInterval(() => {
        seconds--;
        if (seconds > 0) {
          tutorialCountdown.textContent = 'Please wait... ' + seconds;
        } else {
          clearInterval(tutorialTimer);
          tutorialLocked = false;
          tutorialCountdown.textContent = 'You can now close this.';
        }
      }, 1000);
    }

    tutorialCloseBtn.addEventListener('click', () => {
      if (tutorialLocked) return; // hard lock
      tutorialModal.classList.add('hidden');
    });

    // show tutorial on load
    showTutorialBlock();

    // on load routing
    // --- Override tutorial behavior: auto-open on load, no timer ---
    function showTutorialBlock(){ tutorialModal.classList.remove('hidden'); }
    // ensure close works immediately
    tutorialCloseBtn.onclick = function(){ tutorialModal.classList.add('hidden'); };
    // auto show now
    try{ showTutorialBlock(); }catch(e){ /* ignore if elements not ready */ }

    routeFromHash();

    // accessibility: Escape closes tutorial ONLY after unlock
    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (tutorialModal.classList.contains('hidden')) return;
        if (tutorialLocked) return;
        tutorialModal.classList.add('hidden');
      }
    });
