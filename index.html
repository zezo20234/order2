<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mini Shop</title>
  <meta name="theme-color" content="#0ea5a3">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="shop.jpg">
  <style>
    :root{--bg:#ffffff;--muted:#4b5563;--accent2:#0ea5a3}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial;background:var(--bg);color:#0f1724}
    .container{max-width:1100px;margin:28px auto;padding:18px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{margin:0;font-size:22px}
    .controls{display:flex;align-items:center}
    .controls button{margin-left:8px;padding:8px 12px;border-radius:8px;border:0;background:var(--accent2);color:white;cursor:pointer}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:18px}

    .pcard{background:linear-gradient(180deg,#fff,#fff7ed);border-radius:14px;border:3px solid #fde68a;box-shadow:0 12px 30px rgba(15,23,42,0.06);overflow:hidden;display:flex;flex-direction:column}
    .pcard .art{height:150px;background:linear-gradient(180deg,#f3f4f6,#e6eef6);display:flex;align-items:center;justify-content:center}
    .pcard .art img{width:100%;height:100%;object-fit:cover;cursor:pointer;border-radius:6px}
    .pcard .content{padding:12px}
    .pcard h3{margin:0 0 6px 0;font-size:16px}
    .muted{color:var(--muted);font-size:13px}
    .stats{display:flex;gap:8px;align-items:center;margin-top:8px}
    .stat{background:rgba(0,0,0,0.03);padding:6px 8px;border-radius:999px;font-weight:600;font-size:13px}
    .pfooter{display:flex;gap:8px;padding:12px;border-top:1px dashed rgba(15,23,36,0.04);background:linear-gradient(180deg,rgba(255,255,255,0.6),transparent)}
    .btn{padding:8px 12px;border-radius:8px;border:0;background:var(--accent2);color:#fff;cursor:pointer}
    .small{padding:6px 8px;font-size:13px}
    .danger{background:#ef4444}

    /* Modal base */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:20px;z-index:9999}
    .modal.backdrop{background:rgba(2,6,23,0.6)}
    .sheet{width:100%;max-width:560px;background:white;padding:16px;border-radius:12px;box-shadow:0 8px 24px rgba(2,6,23,0.06)}

    /* Image fullscreen modal - visually different */
    #imageModal .sheet{background:transparent;padding:0;max-width:95vw}
    #fullImage{max-width:100%;max-height:85vh;border-radius:12px;display:block;margin:0 auto;background:#fff;padding:6px;box-shadow:0 10px 30px rgba(2,6,23,0.25)}
    .image-controls{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}

    .thumb{width:72px;height:72px;object-fit:cover;border-radius:8px;cursor:pointer;border:1px solid rgba(15,23,36,0.04);background:#fff}

    @media (max-width:520px){.pcard .art{height:120px}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Mini Shop</h1>
      <div class="controls">
        <button id="addProductBtn" class="btn">‚ûï Add product</button>
        <button id="ordersBtn" class="btn small">üîí Orders</button>
        <button id="myOrdersBtn" class="btn small">üßæ My Orders</button>
        <button id="installBtn" class="btn small" style="display:none;margin-left:8px">‚¨áÔ∏è Install</button>
        <button id="tutorialBtn" class="btn small" style="margin-left:8px">üì± Tutorial</button>
      </div>
    </header>

    <section>
      <h2 class="muted">Products</h2>
      <div id="products" class="grid" aria-live="polite"></div>
    </section>

    <footer>
      <div class="muted">Tip: For best experience, add this app to your home screen.</div>
    </footer>
  </div>

  <!-- Product modal -->
  <div id="productModal" class="modal backdrop" style="display:none">
    <div class="sheet">
      <h3>Add product</h3>
      <div style="margin-top:8px">
        <label>Title</label>
        <input id="pTitle" placeholder="e.g. Blue Potion" />
        <label style="margin-top:8px">Description</label>
        <textarea id="pDesc" rows="3"></textarea>
        <label style="margin-top:8px">Choose image from device</label>
        <input id="pImageFile" type="file" accept="image/*" />
        <div id="uploadingNote" class="muted" style="margin-top:6px;display:none">Processing image‚Ä¶</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
          <div>
            <label>Price</label>
            <input id="pPrice" type="number" min="0" />
          </div>
          <div>
            <label>Quantity</label>
            <input id="pQty" type="number" min="0" />
          </div>
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
          <button id="pCancel" class="btn small">Cancel</button>
          <button id="pSave" class="btn">Save product</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Buy modal -->
  <div id="buyModal" class="modal backdrop" style="display:none">
    <div class="sheet">
      <h3>Place order</h3>
      <div style="margin-top:8px">
        <label>Name</label>
        <input id="oName" />
        <label style="margin-top:8px">Day</label>
        <select id="oDay">
          <option>Sunday</option><option>Monday</option><option>Tuesday</option><option>Wednesday</option><option>Thursday</option>
        </select>
        <label style="margin-top:8px">Quantity</label>
        <input id="oQty" type="number" min="1" />
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
          <button id="oCancel" class="btn small">Cancel</button>
          <button id="oPlace" class="btn">Place order</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Orders modal -->
  <div id="ordersModal" class="modal backdrop" style="display:none">
    <div class="sheet">
      <h3>All orders (admin)</h3>
      <div id="ordersList" style="margin-top:8px;display:grid;gap:8px;max-height:60vh;overflow:auto"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button id="ordersClose" class="btn small">Close</button>
      </div>
    </div>
  </div>

  <!-- My orders modal -->
  <div id="myOrdersModal" class="modal backdrop" style="display:none">
    <div class="sheet">
      <h3>My orders</h3>
      <div style="margin-top:8px">
        <label>Enter name to view your orders</label>
        <input id="myName" />
        <div id="myOrdersList" style="margin-top:12px;display:grid;gap:8px;max-height:50vh;overflow:auto"></div>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
          <button id="myOrdersClose" class="btn small">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Tutorial modal -->
  <div id="tutorialModal" class="modal backdrop" style="display:none">
    <div class="sheet">
      <h3>How to Add to Home Screen</h3>
      <p class="muted">Follow the steps for your device. You can also use the Install button (if shown) on Android.</p>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button id="tutorialClose" class="btn small">Close</button>
      </div>
    </div>
  </div>

  <!-- Image fullscreen modal -->
  <div id="imageModal" class="modal backdrop" style="display:none">
    <div class="sheet" role="dialog" aria-modal="true" aria-label="Full image view">
      <div style="text-align:center">
        <img id="fullImage" src="" alt="full view" />
      </div>
      <div class="image-controls">
        <button id="closeImageBtn" class="btn small">Close</button>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    // PWA manifest / SW (unchanged)
    (function createManifestAndSW(){
      const manifest = { name:'Mini Shop', short_name:'MiniShop', start_url:'.', display:'standalone', background_color:'#ffffff', theme_color:'#0ea5a3', icons:[{src:'shop.jpg',sizes:'192x192',type:'image/jpeg'},{src:'shop.jpg',sizes:'512x512',type:'image/jpeg'}] };
      const manifestBlob = new Blob([JSON.stringify(manifest)], {type:'application/json'});
      const manifestURL = URL.createObjectURL(manifestBlob);
      let link = document.querySelector('link[rel="manifest"]');
      if(!link){ link = document.createElement('link'); link.rel = 'manifest'; document.head.appendChild(link); }
      link.href = manifestURL;
      const swSource = `
        const CACHE = 'mini-shop-cache-v1';
        const ASSETS = ['.', 'index.html', 'shop.jpg'];
        self.addEventListener('install', e=> e.waitUntil(caches.open(CACHE).then(c=>c.addAll(ASSETS)).then(()=>self.skipWaiting())));
        self.addEventListener('activate', e=> e.waitUntil(clients.claim()));
        self.addEventListener('fetch', e=> e.respondWith(caches.match(e.request).then(r=> r || fetch(e.request).catch(()=>caches.match('index.html')))));
      `;
      const swBlob = new Blob([swSource], {type:'text/javascript'});
      const swURL = URL.createObjectURL(swBlob);
      if('serviceWorker' in navigator) navigator.serviceWorker.register(swURL).catch(()=>{});
    })();

    // beforeinstallprompt
    let deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt = e; document.getElementById('installBtn').style.display='inline-block'; });
    document.getElementById('installBtn').addEventListener('click', async ()=>{
      if(!deferredPrompt) return alert('Install prompt not available.');
      deferredPrompt.prompt();
      const choice = await deferredPrompt.userChoice;
      if(choice.outcome === 'accepted') alert('Thanks ‚Äî app installed!');
      deferredPrompt = null;
      document.getElementById('installBtn').style.display = 'none';
    });

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCOrJhv-bit0awn3mJacHbjEFnolzv0Ntw",
      authDomain: "minishop-67dbf.firebaseapp.com",
      databaseURL: "https://minishop-67dbf-default-rtdb.firebaseio.com",
      projectId: "minishop-67dbf",
      storageBucket: "minishop-67dbf.appspot.com",
      messagingSenderId: "7379826226",
      appId: "1:7379826226:web:4d8f6f9cbc679cc600ae2b",
      measurementId: "G-6N23NYNRDB"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // DOM refs
    const productsEl = document.getElementById('products');
    const addProductBtn = document.getElementById('addProductBtn');
    const productModal = document.getElementById('productModal');
    const pCancel = document.getElementById('pCancel');
    const pSave = document.getElementById('pSave');
    const pTitle = document.getElementById('pTitle');
    const pDesc = document.getElementById('pDesc');
    const pPrice = document.getElementById('pPrice');
    const pQty = document.getElementById('pQty');
    const pImageFile = document.getElementById('pImageFile');
    const uploadingNote = document.getElementById('uploadingNote');

    const buyModal = document.getElementById('buyModal');
    const oName = document.getElementById('oName');
    const oDay = document.getElementById('oDay');
    const oQty = document.getElementById('oQty');
    const oCancel = document.getElementById('oCancel');
    const oPlace = document.getElementById('oPlace');

    const ordersBtn = document.getElementById('ordersBtn');
    const ordersModal = document.getElementById('ordersModal');
    const ordersList = document.getElementById('ordersList');
    const ordersClose = document.getElementById('ordersClose');

    const myOrdersBtn = document.getElementById('myOrdersBtn');
    const myOrdersModal = document.getElementById('myOrdersModal');
    const myOrdersClose = document.getElementById('myOrdersClose');
    const myName = document.getElementById('myName');
    const myOrdersList = document.getElementById('myOrdersList');

    const tutorialBtn = document.getElementById('tutorialBtn');
    const tutorialModal = document.getElementById('tutorialModal');
    const tutorialClose = document.getElementById('tutorialClose');

    // image modal refs
    const imageModal = document.getElementById('imageModal');
    const fullImage = document.getElementById('fullImage');
    const closeImageBtn = document.getElementById('closeImageBtn');

    // utility modal open/close
    function openModal(el){ if(!el) return; el.style.display = 'flex'; }
    function closeModal(el){ if(!el) return; el.style.display = 'none'; }

    // close handlers
    closeImageBtn.addEventListener('click', ()=> closeModal(imageModal));
    // click overlay to close (only when clicking backdrop, not inner sheet)
    imageModal.addEventListener('click', (ev)=> { if(ev.target === imageModal) closeModal(imageModal); });
    // prevent clicks on the image from closing modal
    fullImage.addEventListener('click', (ev)=> ev.stopPropagation());

    // tutorial open/close
    tutorialBtn.addEventListener('click', ()=> openModal(tutorialModal));
    tutorialClose.addEventListener('click', ()=> closeModal(tutorialModal));
    // auto-open tutorial every load as you wanted
    window.addEventListener('load', ()=> { try { openModal(tutorialModal); } catch(e){} });

    // basic helpers
    function readFileAsDataURL(file){
      return new Promise((res,rej)=>{
        const reader = new FileReader();
        reader.onload = ()=>res(reader.result);
        reader.onerror = ()=>rej(new Error('Failed to read file'));
        reader.readAsDataURL(file);
      });
    }
    async function downsizeDataUrlIfNeeded(dataUrl){
      try{
        const approxKb = Math.ceil((dataUrl.length * 3/4) / 1024);
        if(approxKb <= 500) return dataUrl;
        const img = await new Promise((res, rej)=>{const i=new Image(); i.onload=()=>res(i); i.onerror=()=>rej(new Error('img load fail')); i.src=dataUrl});
        const maxDim = 1200;
        let w = img.width, h = img.height;
        if(w>maxDim || h>maxDim){ const ratio = Math.min(maxDim/w, maxDim/h); w = Math.round(w*ratio); h = Math.round(h*ratio); }
        const canv = document.createElement('canvas'); canv.width = w; canv.height = h;
        const ctx = canv.getContext('2d'); ctx.drawImage(img,0,0,w,h);
        return canv.toDataURL('image/jpeg', 0.8);
      } catch(e){ return dataUrl; }
    }

    // Save product
    async function saveProduct(){
      const title = pTitle.value.trim();
      const description = pDesc.value.trim();
      const price = parseFloat(pPrice.value) || 0;
      const quantity = parseInt(pQty.value) || 0;
      if(!title){ alert('Please add a title'); return; }

      let imageData = '';
      const file = pImageFile.files && pImageFile.files[0];
      try{
        if(file){
          uploadingNote.style.display = 'block';
          pSave.disabled = true;
          const dataUrl = await readFileAsDataURL(file);
          imageData = await downsizeDataUrlIfNeeded(dataUrl);
          uploadingNote.style.display = 'none';
          pSave.disabled = false;
        }
      }catch(err){
        uploadingNote.style.display = 'none';
        pSave.disabled = false;
        alert('Image processing failed: ' + err.message);
        return;
      }

      const newRef = db.ref('products').push();
      newRef.set({title,description,price,quantity,imageData,createdAt:Date.now()}).then(()=>{
        closeModal(productModal);
        pTitle.value=''; pDesc.value=''; pPrice.value=''; pQty.value=''; pImageFile.value='';
      }).catch(err=> alert('Error saving product: '+err.message));
    }

    // Delete product
    async function attemptDeleteProduct(productId, productData){
      const code = prompt('Enter admin code to delete this product');
      if(code === null) return;
      if(code !== '555') return alert('Wrong code ‚Äî product not deleted.');
      if(!confirm('Delete product "'+(productData.title||'')+'"?')) return;
      try{ await db.ref('products/'+productId).remove(); alert('Product deleted.'); }
      catch(err){ alert('Failed to delete product: '+err.message); }
    }

    // Buy flow
    let currentBuyProduct = null;
    function openBuy(id,data){
      currentBuyProduct = {id,data};
      oName.value = localStorage.getItem('mini_shop_name') || '';
      oDay.value = 'Sunday';
      oQty.value = 1;
      oQty.max = Math.max(1,(data.quantity||0));
      openModal(buyModal);
    }
    function placeOrder(){
      if(!currentBuyProduct) return;
      const name = oName.value.trim();
      const day = oDay.value;
      let qty = parseInt(oQty.value) || 1;
      const prod = currentBuyProduct.data;
      if(!name){ alert('Please enter your name'); return; }
      if(qty < 1){ alert('Quantity must be at least 1'); return; }
      if(qty > (prod.quantity||0)){ alert('Not enough quantity available'); return; }
      const newOrderRef = db.ref('orders').push();
      const orderObj = { productId: currentBuyProduct.id, productTitle: prod.title||'', buyerName: name, day: day, quantity: qty, status: 'pending', createdAt: Date.now() };
      newOrderRef.set(orderObj).then(()=>{ localStorage.setItem('mini_shop_name', name); closeModal(buyModal); alert('Order placed!'); }).catch(err=>alert('Error: '+err.message));
    }

    // Orders admin
    function openAdminOrders(){
      const code = prompt('Enter admin code to open orders');
      if(!code) return;
      if(code !== '555'){ alert('Wrong code'); return; }
      openModal(ordersModal);
    }

    async function handleAcceptOrder(orderId,orderData){
      if(orderData.status === 'accepted'){ alert('Order already accepted.'); return; }
      const prodSnap = await db.ref('products/'+orderData.productId).get();
      const prod = prodSnap.val();
      if(!prod){ alert('Product not found'); return; }
      const available = prod.quantity || 0;
      const orderQty = parseInt(orderData.quantity) || 1;
      if(orderQty > available && !confirm('Qty > stock. Accept and set stock to 0?')) return;
      const qtyRef = db.ref('products/'+orderData.productId+'/quantity');
      qtyRef.transaction(current => { if(current===null) return 0; let next = current - orderQty; if(next<0) next=0; return next; }, (err,committed)=>{
        if(err) alert('Transaction failed: '+err.message);
        else if(!committed) alert('Could not update quantity');
        else db.ref('orders/'+orderId).update({ status:'accepted', handledAt:Date.now() });
      });
    }

    async function handleDeliverOrder(orderId,orderData){
      if(orderData.status === 'delivered'){ alert('Order already delivered.'); return; }
      if(orderData.status === 'pending' && !confirm('This order is pending. Deliver anyway? (stock not reduced)')) return;
      db.ref('orders/'+orderId).update({ status:'delivered', deliveredAt:Date.now() });
    }

    async function handleDeclineOrder(orderId,orderData){
      if(!confirm('Decline this order?')) return;
      const orderQty = parseInt(orderData.quantity) || 1;
      const doSetDeclined = (extraFields = {}) => db.ref('orders/'+orderId).update(Object.assign({ status:'declined', handledAt:Date.now() }, extraFields));
      if(orderData.status === 'accepted' || orderData.status === 'delivered'){
        const qtyRef = db.ref('products/'+orderData.productId+'/quantity');
        qtyRef.transaction(current => (current || 0) + orderQty, (err,committed,snap)=> {
          if(err) alert('Could not restore quantity: '+err.message);
          else if(!committed) alert('Could not restore quantity');
          else doSetDeclined({restoredAt:Date.now()});
        });
      } else doSetDeclined();
    }

    // Image viewer: open fullscreen modal
    function openImageModal(src){
      if(!src) return;
      fullImage.src = src;
      // ensure image loads before opening to avoid flicker (optional)
      fullImage.onload = ()=> openModal(imageModal);
      fullImage.onerror = ()=> { fullImage.src = ''; alert('Could not load image'); };
    }

    // Render products
    function renderProductsList(snapshot){
      productsEl.innerHTML = '';
      const val = snapshot.val() || {};
      const entries = Object.entries(val).filter(([id,data]) => (data.quantity || 0) > 0);
      if(entries.length === 0){ productsEl.innerHTML = '<div class="muted">No products yet. Add one!</div>'; return; }
      entries.sort((a,b)=> (b[1].createdAt||0) - (a[1].createdAt||0));
      entries.forEach(([id,data])=>{
        const card = document.createElement('div'); card.className = 'pcard';
        const art = document.createElement('div'); art.className = 'art';
        if(data.imageData){
          const img = document.createElement('img'); img.src = data.imageData; img.alt = data.title || 'product';
          img.addEventListener('click', ()=> openImageModal(data.imageData));
          art.appendChild(img);
        } else {
          const ph = document.createElement('div'); ph.className='muted'; ph.textContent = 'No image'; art.appendChild(ph);
        }
        card.appendChild(art);

        const content = document.createElement('div'); content.className='content';
        const title = document.createElement('h3'); title.textContent = data.title || '';
        content.appendChild(title);
        const desc = document.createElement('div'); desc.className='muted'; desc.textContent = data.description || '';
        content.appendChild(desc);

        const stats = document.createElement('div'); stats.className='stats';
        const price = document.createElement('div'); price.className='stat'; price.innerHTML = (Number(data.price).toFixed(2)||'0.00');
        const qty = document.createElement('div'); qty.className='stat'; qty.textContent = 'Qty: '+(data.quantity||0);
        stats.appendChild(price); stats.appendChild(qty);
        content.appendChild(stats);
        card.appendChild(content);

        const footer = document.createElement('div'); footer.className='pfooter';
        const buyBtn = document.createElement('button'); buyBtn.className='btn small'; buyBtn.textContent='Buy';
        buyBtn.disabled = !(data.quantity>0);
        buyBtn.addEventListener('click', ()=> openBuy(id,data));
        footer.appendChild(buyBtn);

        const deleteBtn = document.createElement('button'); deleteBtn.className='btn small danger'; deleteBtn.style.marginLeft='8px';
        deleteBtn.textContent = 'Delete'; deleteBtn.title = 'Requires admin code';
        deleteBtn.addEventListener('click', ()=> attemptDeleteProduct(id, data));
        footer.appendChild(deleteBtn);

        const meta = document.createElement('div'); meta.style.marginLeft='auto'; meta.className='muted'; meta.style.fontSize='12px';
        meta.textContent = new Date((data.createdAt||0)).toLocaleDateString();
        footer.appendChild(meta);

        card.appendChild(footer);
        productsEl.appendChild(card);
      });
    }

    // Render orders (admin)
    function renderOrders(snapshot){
      ordersList.innerHTML = '';
      const val = snapshot.val() || {};
      const entries = Object.entries(val).sort((a,b)=> (b[1].createdAt||0) - (a[1].createdAt||0));
      if(entries.length === 0){ ordersList.innerHTML = '<div class="muted">No orders yet</div>'; return; }
      entries.forEach(([id,data])=>{
        const box = document.createElement('div'); box.className='ticket';
        const top = document.createElement('div'); top.className='flex';
        const title = document.createElement('div'); title.innerHTML = '<strong>'+data.productTitle+'</strong>';
        const badge = document.createElement('div'); badge.className='badge'; badge.style.marginLeft='auto'; badge.textContent = (data.status||'pending');
        top.appendChild(title); top.appendChild(badge);
        box.appendChild(top);

        const info = document.createElement('div'); info.className='muted'; info.style.marginTop='6px';
        info.innerHTML = 'Buyer: '+(data.buyerName||'')+' ‚Äî Qty: '+(data.quantity||0)+' ‚Äî Day: '+(data.day||'')+'<br/>' + new Date((data.createdAt||0)).toLocaleString();
        box.appendChild(info);

        const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px'; actions.style.marginTop='8px';
        const accept = document.createElement('button'); accept.className='btn small'; accept.textContent='Accept';
        const deliver = document.createElement('button'); deliver.className='btn small'; deliver.textContent='Deliver';
        const decline = document.createElement('button'); decline.className='btn small danger'; decline.textContent='Decline';
        accept.addEventListener('click', ()=> handleAcceptOrder(id,data));
        deliver.addEventListener('click', ()=> handleDeliverOrder(id,data));
        decline.addEventListener('click', ()=> handleDeclineOrder(id,data));
        actions.appendChild(accept); actions.appendChild(deliver); actions.appendChild(decline);
        box.appendChild(actions);
        ordersList.appendChild(box);

        // fetch product to show thumbnail (clickable)
        (async ()=>{
          try{
            const prodSnap = await db.ref('products/'+data.productId).get();
            const prod = prodSnap.exists() ? prodSnap.val() : null;
            if(prod && prod.imageData){
              const thumb = document.createElement('img');
              thumb.src = prod.imageData;
              thumb.className = 'thumb';
              thumb.style.marginLeft = '10px';
              thumb.addEventListener('click', ()=> openImageModal(prod.imageData));
              top.insertBefore(thumb, badge);
            }
          }catch(e){
            console.warn('thumbnail fetch failed', e);
          }
        })();
      });
    }

    // My orders list
    function refreshMyOrders(){
      const name = (myName.value || localStorage.getItem('mini_shop_name') || '').trim();
      myOrdersList.innerHTML = '';
      if(!name){ myOrdersList.innerHTML = '<div class="muted">Enter your name to view orders</div>'; return; }
      const q = db.ref('orders').orderByChild('buyerName').equalTo(name);
      q.once('value', snap=>{
        const val = snap.val() || {};
        const items = Object.entries(val).sort((a,b)=> (b[1].createdAt||0) - (a[1].createdAt||0));
        if(items.length === 0){ myOrdersList.innerHTML = '<div class="muted">No orders found for "'+name+'"</div>'; return; }
        items.forEach(([id,data])=>{
          const box = document.createElement('div'); box.className='ticket';
          const top = document.createElement('div'); top.className='flex';
          const title = document.createElement('div'); title.innerHTML = '<strong>'+data.productTitle+'</strong>';
          const badge = document.createElement('div'); badge.className='badge'; badge.style.marginLeft='auto'; badge.textContent = (data.status||'pending');
          top.appendChild(title); top.appendChild(badge);
          box.appendChild(top);

          const info = document.createElement('div'); info.className='muted'; info.style.marginTop='6px';
          info.innerHTML = 'Qty: '+(data.quantity||0)+' ‚Äî Day: '+(data.day||'')+'<br/>' + new Date((data.createdAt||0)).toLocaleString();
          box.appendChild(info);

          // Add thumbnail
          (async ()=>{
            try{
              const prodSnap = await db.ref('products/'+data.productId).get();
              const prod = prodSnap.exists() ? prodSnap.val() : null;
              if(prod && prod.imageData){
                const thumb = document.createElement('img');
                thumb.src = prod.imageData;
                thumb.className = 'thumb';
                thumb.style.marginLeft = '10px';
                thumb.addEventListener('click', ()=> openImageModal(prod.imageData));
                top.insertBefore(thumb, badge);
              }
            }catch(e){ console.warn('my orders thumbnail failed', e); }
          })();

          myOrdersList.appendChild(box);
        });
      });
    }

    // listeners & wiring
    addProductBtn.addEventListener('click', ()=> { const code = prompt('Enter code'); if(code !== '555') return; openModal(productModal); });
    pCancel.addEventListener('click', ()=> { closeModal(productModal); pTitle.value=''; pDesc.value=''; pPrice.value=''; pQty.value=''; pImageFile.value='';});
    pSave.addEventListener('click', saveProduct);

    oCancel.addEventListener('click', ()=> closeModal(buyModal));
    oPlace.addEventListener('click', placeOrder);

    ordersBtn.addEventListener('click', openAdminOrders);
    ordersClose.addEventListener('click', ()=> closeModal(ordersModal));

    myOrdersBtn.addEventListener('click', ()=> { openModal(myOrdersModal); const saved = localStorage.getItem('mini_shop_name'); if(saved) myName.value = saved; refreshMyOrders(); });
    myOrdersClose.addEventListener('click', ()=> closeModal(myOrdersModal));
    myName.addEventListener('input', ()=> { localStorage.setItem('mini_shop_name', myName.value); refreshMyOrders(); });

    // realtime listeners
    db.ref('products').on('value', renderProductsList);
    db.ref('orders').on('value', renderOrders);
    db.ref('orders').on('value', ()=> { if(myOrdersModal.style.display === 'flex') refreshMyOrders(); });

    // close modals on ESC
    window.addEventListener('keydown', (e)=> { if(e.key === 'Escape'){ document.querySelectorAll('.modal').forEach(m=>m.style.display='none'); } });

  </script>
</body>
</html>
