<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mini Shop</title>
  <style>
    :root{ --bg:#071029; --card:#0b1220; --accent:#06b6d4; --muted:#94a3b8; --glass: rgba(255,255,255,0.03); }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;color:#e6eef8;background:linear-gradient(180deg,#041022 0%, #071a2e 100%);}
    .wrap{max-width:1100px;margin:28px auto;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
    h1{font-size:1.4rem;margin:0}
    .controls{display:flex;gap:10px;align-items:center}
    .btn{background:linear-gradient(90deg,var(--accent),#7c3aed);border:none;padding:10px 14px;border-radius:12px;color:white;font-weight:600;cursor:pointer;box-shadow:0 6px 18px rgba(2,6,23,0.6);transition:transform .14s ease}
    .btn:active{transform:translateY(2px) scale(.995)}
    .link-btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:10px;color:var(--muted);text-decoration:none}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:14px;padding:12px;backdrop-filter: blur(6px);border:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column;gap:8px;align-items:stretch;animation:pop .26s ease both}
    @keyframes pop{from{opacity:0;transform:translateY(8px) scale(.98)}to{opacity:1;transform:none}}
    .thumb{height:140px;border-radius:10px;overflow:hidden;display:flex;align-items:center;justify-content:center;background:var(--glass)}
    .thumb img{max-width:100%;max-height:100%;object-fit:cover}
    .title{font-weight:700}
    .desc{font-size:.85rem;color:var(--muted);min-height:36px}
    .row{display:flex;justify-content:space-between;align-items:center}
    .price{font-weight:800;display:flex;align-items:center;gap:8px}
    .qty{font-size:.9rem;color:var(--muted)}
    .small{font-size:.82rem;color:var(--muted)}
    .buy{margin-top:8px;padding:10px;border-radius:10px;border:none;background:linear-gradient(90deg,#10b981,#06b6d4);color:#053;cursor:pointer;font-weight:700}
    .buy[disabled]{opacity:.35;cursor:not-allowed}
    .empty{padding:40px;border-radius:12px;background:rgba(255,255,255,0.02);text-align:center;color:var(--muted)}
    .toast{position:fixed;right:18px;bottom:18px;background:#071a2e;padding:12px 16px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 10px 30px rgba(2,6,23,0.6);color:#e6eef8}
    @media (max-width:420px){.thumb{height:110px}.wrap{padding:12px}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Mini Shop</h1>
      <div class="controls">
        <button id="addBtn" class="btn link-btn">➕ Add product</button>
        <button class="btn" id="refreshBtn" title="Refresh products">Refresh</button>
      </div>
    </header>

    <main>
      <div id="productsArea" class="grid"></div>
    </main>
  </div>

  <div id="toastRoot" aria-live="polite"></div>

  <!-- Firebase JS (modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getFirestore, collection, onSnapshot, doc, runTransaction, query, orderBy, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    // --- REPLACE with your Firebase config if different ---
    const firebaseConfig = {
      apiKey: "AIzaSyCOrJhv-bit0awn3mJacHbjEFnolzv0Ntw",
      authDomain: "minishop-67dbf.firebaseapp.com",
      projectId: "minishop-67dbf",
      storageBucket: "minishop-67dbf.appspot.com",
      messagingSenderId: "7379826226",
      appId: "1:7379826226:web:4d8f6f9cbc679cc600ae2b",
      measurementId: "G-6N23NYNRDB"
    };

    const ADD_PAGE = 'add-product.html'; // link to add page
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const productsArea = document.getElementById('productsArea');
    const toastRoot = document.getElementById('toastRoot');
    const addBtn = document.getElementById('addBtn');
    const refreshBtn = document.getElementById('refreshBtn');

    function toast(text){
      const div = document.createElement('div'); div.className='toast'; div.textContent = text; toastRoot.appendChild(div);
      setTimeout(()=>{div.style.opacity=0;div.style.transform='translateY(10px)';setTimeout(()=>div.remove(),500)},2300)
    }

    function formatPrice(n){
      const v = Number(n) || 0;
      return v.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ر.س';
    }

    // Real-time products listener
    const productsCol = collection(db, 'products');
    const productsQ = query(productsCol, orderBy('createdAt', 'desc'));
    onSnapshot(productsQ, (snap) => {
      const arr = [];
      snap.forEach(d => arr.push({ id: d.id, ...d.data() }));
      renderProducts(arr);
    }, (err) => {
      console.error('products onSnapshot error', err);
      toast('Error loading products (see console)');
    });

    function renderProducts(products){
      productsArea.innerHTML = '';
      if(!products.length){
        productsArea.innerHTML = '<div class="empty"><strong>No products yet.</strong><br>Use Add product to list something.</div>'; return;
      }

      for(const p of products){
        const card = document.createElement('div'); card.className='card'; card.dataset.id = p.id;
        const thumb = document.createElement('div'); thumb.className='thumb';
        const img = document.createElement('img'); img.alt = p.title || 'product';
        img.src = p.photoURL || ('data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="600" height="400"><rect width="100%" height="100%" fill="#0b1220"/></svg>'));
        thumb.appendChild(img);

        const title = document.createElement('div'); title.className='title'; title.textContent = p.title || 'Untitled';
        const desc = document.createElement('div'); desc.className='desc'; desc.textContent = p.description || '';
        const row = document.createElement('div'); row.className='row';
        const price = document.createElement('div'); price.className='price'; price.textContent = formatPrice(p.price);
        const qty = document.createElement('div'); qty.className='qty'; qty.textContent = 'Quantity: ' + (Number(p.quantity||0));
        row.appendChild(price); row.appendChild(qty);

        const buy = document.createElement('button'); buy.className='buy'; buy.textContent = 'Buy';
        if(!p.quantity || p.quantity <= 0){ buy.setAttribute('disabled',''); buy.textContent = 'Sold out' }
        buy.addEventListener('click', ()=>onBuy(p.id, p.title, p.price));

        card.appendChild(thumb); card.appendChild(title); card.appendChild(desc); card.appendChild(row); card.appendChild(buy);
        productsArea.appendChild(card);
      }
    }

    // Purchase transaction: decrement quantity and create buyer doc with serverTimestamp
    async function onBuy(productId, title, price){
      const name = prompt('Enter your name to complete the purchase (example: zezo):', 'zezo');
      if(name === null) return;
      const buyerName = (name.trim() || 'Anonymous');

      const productRef = doc(db, 'products', productId);
      const buyersCol = collection(db, 'buyers');

      try{
        await runTransaction(db, async (tx) => {
          const prodSnap = await tx.get(productRef);
          if(!prodSnap.exists()) throw new Error('Product no longer exists.');
          const currentQty = Number(prodSnap.data().quantity || 0);
          if(currentQty <= 0) throw new Error('Product sold out.');

          // decrement
          tx.update(productRef, { quantity: currentQty - 1 });

          // create buyer doc (generate id by using doc(collection))
          const newBuyerRef = doc(buyersCol); // generates a new id
          tx.set(newBuyerRef, {
            name: buyerName,
            productId,
            productTitle: title || 'Untitled',
            price: Number(price || 0),
            time: serverTimestamp()
          });
        });
        toast('Thanks ' + buyerName + ' — purchase saved.');
      }catch(err){
        console.error('purchase error', err);
        alert('Purchase failed: ' + (err.message || err));
      }
    }

    addBtn.addEventListener('click', ()=>{ window.location.href = ADD_PAGE; });
    refreshBtn.addEventListener('click', ()=>{ toast('Refreshed'); });
  </script>
</body>
</html>
