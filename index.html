<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mini Shop â€” Updated</title>
  <meta name="theme-color" content="#0ea5a3">
  <style>
    :root{--bg:#ffffff;--card:#fff9f0;--muted:#4b5563;--accent:#ef4444;--accent2:#0ea5a3}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial;background:var(--bg);color:#0f1724}
    .container{max-width:1100px;margin:28px auto;padding:18px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{margin:0;font-size:22px}
    .controls{display:flex;align-items:center}
    .controls button{margin-left:8px;padding:8px 12px;border-radius:8px;border:0;background:var(--accent2);color:white;cursor:pointer}
    nav a{margin-right:10px;color:var(--muted);text-decoration:none}

    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:18px}

    /* PokÃ©mon-card style */
    .pcard{background:linear-gradient(180deg,#fff,#fff7ed);border-radius:14px;border:3px solid #fde68a;box-shadow:0 12px 30px rgba(15,23,42,0.06);overflow:hidden;display:flex;flex-direction:column}
    .pcard .art{height:170px;background:linear-gradient(180deg,#f3f4f6,#e6eef6);display:flex;align-items:center;justify-content:center}
    .pcard .art img{width:100%;height:100%;object-fit:cover}
    .pcard .content{padding:12px}
    .pcard h3{margin:0 0 6px 0;font-size:16px}
    .muted{color:var(--muted);font-size:13px}
    .stats{display:flex;gap:8px;align-items:center;margin-top:8px}
    .stat{background:rgba(0,0,0,0.03);padding:6px 8px;border-radius:999px;font-weight:600;font-size:13px}
    .moneyicon{width:22px;height:22px;vertical-align:middle;margin-right:6px;border-radius:4px;} 
    .pfooter{display:flex;gap:8px;padding:12px;border-top:1px dashed rgba(15,23,36,0.04);background:linear-gradient(180deg,rgba(255,255,255,0.6),transparent)}
    .btn{padding:8px 12px;border-radius:8px;border:0;background:var(--accent2);color:#fff;cursor:pointer}
    .small{padding:6px 8px;font-size:13px}
    .danger{background:#ef4444}

    .hidden{display:none}
    .page{display:none}
    .page.active{display:block}

    .sheet{background:white;padding:16px;border-radius:12px;box-shadow:0 8px 24px rgba(2,6,23,0.06)}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:8px}

    .ticket{background:#ffffff;padding:12px;border-radius:8px;border:1px solid rgba(15,23,36,0.04);box-shadow:0 6px 18px rgba(15,23,36,0.03)}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;background:rgba(15,23,36,0.04);font-size:12px}
    .flex{display:flex;gap:8px;align-items:center}

    input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(15,23,36,0.06);background:transparent;color:inherit}

    .topbar{display:flex;gap:12px;align-items:center}
    .pill{padding:8px 12px;border-radius:999px;background:#f1f5f9;border:1px solid rgba(15,23,36,0.04)}

    .cart-count{background:#ef4444;color:#fff;padding:2px 8px;border-radius:999px;font-weight:700;margin-left:6px}

    /* tutorial modal overlay */
    .modal{position:fixed;inset:0;background:rgba(2,6,23,0.4);display:flex;align-items:center;justify-content:center;padding:20px;z-index:9999}
    .tutorial-box{width:100%;max-width:560px;padding:18px;border-radius:12px;background:white}
    .no-pointer{pointer-events:none;opacity:0.6}

    @media (max-width:520px){.pcard .art{height:120px}.form-row{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Mini Shop</h1>
        <div class="muted">Small demo shop with accounts, cart & admin</div>
      </div>
      <div class="controls">
        <nav class="topbar">
          <a href="#/" title="Home">Home</a>
          <a href="#/my-orders">My Orders</a>
          <a href="#/cart">My Cart <span id="cartCount" class="cart-count hidden">0</span></a>
          <a id="btnAddProduct" href="#/add-product">Add product</a>
          <a id="btnAdminOrders" href="#/admin-orders">Orders</a>
        </nav>
        <div style="width:12px"></div>
        <div id="userArea" style="display:flex;align-items:center;gap:8px;margin-left:12px">
          <div id="userName" class="muted"></div>
          <button id="btnLogin" class="btn small">Login</button>
          <button id="btnLogout" class="btn small hidden">Logout</button>
        </div>
      </div>
    </header>

    <!-- Pages -->
    <main>
      <section id="homePage" class="page active">
        <h2 class="muted">Products</h2>
        <div id="products" class="grid" aria-live="polite"></div>
      </section>

      <section id="addProductPage" class="page">
        <div class="sheet">
          <h3>Add product (admin)</h3>
          <div style="margin-top:8px">
            <label>Title</label>
            <input id="pTitle" placeholder="e.g. Blue Potion" />
            <label style="margin-top:8px">Description</label>
            <textarea id="pDesc" rows="3"></textarea>
            <label style="margin-top:8px">Choose image from device</label>
            <input id="pImageFile" type="file" accept="image/*" />
            <div id="uploadingNote" class="muted" style="margin-top:6px;display:none">Processing imageâ€¦</div>
            <div class="form-row" style="margin-top:8px">
              <div>
                <label>Price</label>
                <input id="pPrice" type="number" min="0" />
              </div>
              <div>
                <label>Quantity</label>
                <input id="pQty" type="number" min="0" />
              </div>
            </div>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
              <button id="pCancelPage" class="btn small">Cancel</button>
              <button id="pSave" class="btn">Save product</button>
            </div>
          </div>
        </div>
      </section>

      <section id="cartPage" class="page">
        <div class="sheet">
          <h3>My Cart</h3>
          <div id="cartList" style="margin-top:12px;display:grid;gap:8px"></div>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
            <button id="clearCart" class="btn small">Clear</button>
            <button id="placeCartOrder" class="btn">Order</button>
          </div>
        </div>
      </section>

      <section id="myOrdersPage" class="page">
        <div class="sheet">
          <h3>My Orders</h3>
          <div id="myOrdersList" style="margin-top:12px;display:grid;gap:8px"></div>
        </div>
      </section>

      <section id="adminOrdersPage" class="page">
        <div class="sheet">
          <h3>All Orders (admin)</h3>
          <div id="ordersList" style="margin-top:8px;display:grid;gap:8px;max-height:60vh;overflow:auto"></div>
        </div>
      </section>

      <section id="loginPage" class="page">
        <div class="sheet">
          <h3 id="loginTitle">Login</h3>
          <div style="margin-top:8px">
            <div id="loginMsg" class="muted">Use first name and password to login</div>
            <label style="margin-top:8px">First name</label>
            <input id="loginFirst" />
            <label style="margin-top:8px">Password</label>
            <input id="loginPass" type="password" />
            <div style="display:flex;align-items:center;gap:8px;margin-top:8px"><input id="keepSignedIn" type="checkbox" /> <label for="keepSignedIn">Keep me signed in</label></div>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
              <button id="gotoRegister" class="btn small">Create account</button>
              <button id="doLogin" class="btn">Login</button>
            </div>
          </div>
        </div>
      </section>

      <section id="registerPage" class="page">
        <div class="sheet">
          <h3>Create Account</h3>
          <div style="margin-top:8px">
            <label>First name</label>
            <input id="regFirst" />
            <label style="margin-top:8px">Last name</label>
            <input id="regLast" />
            <label style="margin-top:8px">Class</label>
            <input id="regClass" />
            <label style="margin-top:8px">Password</label>
            <input id="regPass" type="password" />
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
              <button id="gotoLoginFromReg" class="btn small">Back to login</button>
              <button id="doRegister" class="btn">Create account</button>
            </div>
          </div>
        </div>
      </section>

    </main>

    <footer style="margin-top:18px;color:var(--muted);font-size:13px">Tip: Add to home screen for the best experience.</footer>
  </div>

  <!-- tutorial modal --- shows on entry and blocks close for 5s -->
  <div id="tutorialModal" class="modal hidden">
    <div class="tutorial-box">
      <h3>How to use Mini Shop</h3>
      <p class="muted">Welcome â€” quick tour. You can add products (admin), add items to your cart, create an account, and place orders. Admins accept/decline/deliver orders.</p>
      <ul class="muted">
        <li>To add a product or manage all orders, use the Orders/Add product links (admin code required).</li>
        <li>Your cart is stored locally. On ordering you must login or create an account.</li>
      </ul>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button id="tutorialCloseBtn" class="btn small">Close</button>
      </div>
      <div id="tutorialCountdown" class="muted" style="margin-top:8px">Please wait... 5</div>
    </div>
  </div>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    // ---------- Firebase config (from user) ----------
    const firebaseConfig = {
      apiKey: "AIzaSyCOrJhv-bit0awn3mJacHbjEFnolzv0Ntw",
      authDomain: "minishop-67dbf.firebaseapp.com",
      databaseURL: "https://minishop-67dbf-default-rtdb.firebaseio.com",
      projectId: "minishop-67dbf",
      storageBucket: "minishop-67dbf.appspot.com",
      messagingSenderId: "7379826226",
      appId: "1:7379826226:web:4d8f6f9cbc679cc600ae2b",
      measurementId: "G-6N23NYNRDB"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ---------- App state ----------
    let currentUser = null; // {id, first, last, class}
    const CART_KEY = 'mini_shop_cart_v1';

    // ---------- DOM refs ----------
    const pages = {
      home: document.getElementById('homePage'),
      add: document.getElementById('addProductPage'),
      cart: document.getElementById('cartPage'),
      myOrders: document.getElementById('myOrdersPage'),
      adminOrders: document.getElementById('adminOrdersPage'),
      login: document.getElementById('loginPage'),
      register: document.getElementById('registerPage')
    };

    const productsEl = document.getElementById('products');
    const pTitle = document.getElementById('pTitle');
    const pDesc = document.getElementById('pDesc');
    const pPrice = document.getElementById('pPrice');
    const pQty = document.getElementById('pQty');
    const pImageFile = document.getElementById('pImageFile');
    const pSave = document.getElementById('pSave');
    const pCancelPage = document.getElementById('pCancelPage');

    const cartList = document.getElementById('cartList');
    const cartCountEl = document.getElementById('cartCount');
    const placeCartOrderBtn = document.getElementById('placeCartOrder');
    const clearCartBtn = document.getElementById('clearCart');

    const myOrdersList = document.getElementById('myOrdersList');
    const ordersList = document.getElementById('ordersList');

    const btnLogin = document.getElementById('btnLogin');
    const btnLogout = document.getElementById('btnLogout');
    const userNameEl = document.getElementById('userName');

    // login/register refs
    const loginFirst = document.getElementById('loginFirst');
    const loginPass = document.getElementById('loginPass');
    const doLoginBtn = document.getElementById('doLogin');
    const gotoRegister = document.getElementById('gotoRegister');
    const regFirst = document.getElementById('regFirst');
    const regLast = document.getElementById('regLast');
    const regClass = document.getElementById('regClass');
    const regPass = document.getElementById('regPass');
    const doRegisterBtn = document.getElementById('doRegister');
    const gotoLoginFromReg = document.getElementById('gotoLoginFromReg');
    const keepSignedIn = document.getElementById('keepSignedIn');

    const tutorialModal = document.getElementById('tutorialModal');
    const tutorialCloseBtn = document.getElementById('tutorialCloseBtn');
    const tutorialCountdown = document.getElementById('tutorialCountdown');

    // Routing helpers
    function showPage(name){
      Object.values(pages).forEach(p=>p.classList.remove('active'));
      if(pages[name]) pages[name].classList.add('active');
      window.location.hash = '#/' + (name==='home'? '': name);
      if(name === 'cart') renderCart();
      if(name === 'myOrders') renderMyOrders();
      if(name === 'adminOrders') renderAdminOrders();
    }

    // Hash routing on load/changes
    function routeFromHash(){
      const h = location.hash.replace('#/','');
      if(!h) return showPage('home');
      if(h.startsWith('add-product') || h === 'add') return showPage('add');
      if(h.startsWith('cart')) return showPage('cart');
      if(h.startsWith('my-orders') || h==='my-orders') return showPage('myOrders');
      if(h.startsWith('admin-orders') || h==='admin-orders') return showPage('adminOrders');
      if(h.startsWith('login')) return showPage('login');
      if(h.startsWith('register')) return showPage('register');
      showPage('home');
    }
    window.addEventListener('hashchange', routeFromHash);

    // ---------- Tutorial modal behavior: show on each entry and block close for 5s ----------
    async function showTutorialBlock() {
      tutorialModal.classList.remove('hidden');
      tutorialCloseBtn.disabled = true;
      let seconds = 5;
      tutorialCountdown.textContent = 'Please wait... ' + seconds;
      const interval = setInterval(()=>{
        seconds--; tutorialCountdown.textContent = 'Please wait... ' + seconds;
        if(seconds<=0){ clearInterval(interval); tutorialCloseBtn.disabled=false; tutorialCountdown.textContent='You can now close this.'; }
      },1000);
      tutorialCloseBtn.addEventListener('click', ()=>{ tutorialModal.classList.add('hidden') });
    }

    // ---------- Simple user system (stored on Firebase Realtime DB) ----------
    // NOTE: This is a lightweight username/password system using Realtime DB only (for demo).
    // Accounts are stored under /users with fields: first, last, class, pass (plain text for demo only) - do NOT use in production.

    function saveSession(userObj, keep){
      currentUser = userObj;
      if(keep) localStorage.setItem('mini_shop_userid', userObj.id);
      userNameEl.textContent = userObj.first + ' ' + (userObj.last||'');
      btnLogin.classList.add('hidden'); btnLogout.classList.remove('hidden');
    }
    function clearSession(){ currentUser=null; localStorage.removeItem('mini_shop_userid'); userNameEl.textContent=''; btnLogin.classList.remove('hidden'); btnLogout.classList.add('hidden'); }

    // check stored session
    (function tryRestoreSession(){
      const id = localStorage.getItem('mini_shop_userid');
      if(!id) return;
      db.ref('users/'+id).once('value').then(snap=>{ const v=snap.val(); if(v) saveSession({id:id, ...v}, true); });
    })();

    // register
    doRegisterBtn.addEventListener('click', async ()=>{
      const first = regFirst.value.trim(); const last = regLast.value.trim(); const cls = regClass.value.trim(); const pass = regPass.value;
      if(!first||!pass){ return alert('Please provide first name and password'); }
      // ensure unique first name (simple check):
      const q = await db.ref('users').orderByChild('first').equalTo(first).once('value');
      if(q.exists()){ return alert('First name already taken. Choose a different first name.'); }
      const r = db.ref('users').push();
      const obj = {first, last, class:cls, pass};
      r.set(obj).then(()=>{
        alert('Account created. You can now login using your first name and password.');
        regFirst.value=''; regLast.value=''; regClass.value=''; regPass.value='';
        showPage('login');
      }).catch(err=>alert('Failed to create account: '+err.message));
    });

    // login
    doLoginBtn.addEventListener('click', async ()=>{
      const first = loginFirst.value.trim(); const pass = loginPass.value;
      if(!first||!pass) return alert('Provide first name and password');
      const snap = await db.ref('users').orderByChild('first').equalTo(first).once('value');
      const val = snap.val();
      if(!val) return alert('No account found with that first name');
      const entries = Object.entries(val);
      // choose first matching
      const [id,userObj] = entries[0];
      if(userObj.pass !== pass) return alert('Incorrect password');
      saveSession({id, ...userObj}, keepSignedIn.checked);
      loginFirst.value=''; loginPass.value=''; keepSignedIn.checked=false;
      alert('Logged in as '+userObj.first);
      // return to cart if came from ordering
      showPage('home');
      routeFromHash();
    });

    btnLogout.addEventListener('click', ()=>{ clearSession(); alert('Logged out'); showPage('home'); });
    btnLogin.addEventListener('click', ()=>{ showPage('login'); });

    gotoRegister.addEventListener('click', ()=> showPage('register'));
    gotoLoginFromReg.addEventListener('click', ()=> showPage('login'));

    // ---------- Cart logic (localStorage-based) ----------
    function getCart(){ try{ return JSON.parse(localStorage.getItem(CART_KEY)||'[]'); }catch(e){ return []; } }
    function saveCart(c){ localStorage.setItem(CART_KEY, JSON.stringify(c)); updateCartCount(); }
    function updateCartCount(){ const c=getCart(); const el=cartCountEl; if(c.length===0){ el.classList.add('hidden'); } else { el.classList.remove('hidden'); el.textContent=c.reduce((s,i)=>s+i.qty,0); } }

    function addToCart(productId, productData){ const c = getCart(); const found = c.find(i=>i.id===productId); if(found){ found.qty = Math.min((productData.quantity||0), found.qty+1); } else { c.push({id:productId, title:productData.title, price:productData.price, qty:1}); } saveCart(c); alert('Added to cart'); }

    function renderCart(){ const c = getCart(); cartList.innerHTML=''; if(c.length===0){ cartList.innerHTML='<div class="muted">Cart is empty</div>'; return; }
      c.forEach(item=>{
        const box = document.createElement('div'); box.className='ticket';
        box.innerHTML = '<div style="display:flex;align-items:center;justify-content:space-between"><strong>'+item.title+'</strong><div>Qty: <input type="number" min="1" value="'+item.qty+'" data-id="'+item.id+'" style="width:70px;padding:6px;border-radius:6px;border:1px solid #eee"></div></div>' +
          '<div class="muted" style="margin-top:6px">Price: '+Number(item.price).toFixed(2)+'</div>';
        const rem = document.createElement('div'); rem.style.display='flex'; rem.style.gap='8px'; rem.style.marginTop='8px';
        const removeBtn = document.createElement('button'); removeBtn.className='btn small danger'; removeBtn.textContent='Remove';
        removeBtn.addEventListener('click', ()=>{ const cc = getCart().filter(i=>i.id!==item.id); saveCart(cc); renderCart(); });
        rem.appendChild(removeBtn);
        box.appendChild(rem);
        cartList.appendChild(box);
      });
      // wire qty inputs
      cartList.querySelectorAll('input[type="number"]').forEach(inp=>{
        inp.addEventListener('change', ()=>{
          const id = inp.dataset.id; const val = Math.max(1,parseInt(inp.value)||1);
          const cc = getCart(); const it = cc.find(x=>x.id===id); if(it) { it.qty = val; saveCart(cc); renderCart(); }
        });
      });
    }

    clearCartBtn.addEventListener('click', ()=>{ if(confirm('Clear cart?')){ saveCart([]); renderCart(); } });

    // Place order from cart: prompt for day only. Must be logged in.
    placeCartOrderBtn.addEventListener('click', async ()=>{
      if(!currentUser) { alert('Please login or create an account before placing an order.'); showPage('login'); return; }
      const cart = getCart(); if(cart.length===0) return alert('Cart is empty');
      const day = prompt('Which day would you like to pick up / deliver? (e.g. Sunday)');
      if(!day) return;
      // create one order per product in cart
      try{
        for(const item of cart){
          // check quantity
          const prodSnap = await db.ref('products/'+item.id).once('value');
          const prod = prodSnap.val();
          const available = (prod && prod.quantity) || 0;
          if(item.qty > available){ if(!confirm('Quantity for "'+item.title+'" exceeds available stock ('+available+'). Place with available qty instead?')) continue; }
          const orderObj = {
            productId: item.id,
            productTitle: item.title,
            buyerId: currentUser.id,
            buyerName: currentUser.first + (currentUser.last?(' '+currentUser.last):''),
            day: day,
            quantity: Math.min(item.qty, available),
            status: 'pending',
            createdAt: Date.now()
          };
          await db.ref('orders').push(orderObj);
        }
        saveCart([]);
        alert('Order(s) placed!');
        showPage('myOrders');
      } catch(err){ alert('Failed to place order: '+err.message); }
    });

    // ---------- Products rendering & save ----------
    function readFileAsDataURL(file){
      return new Promise((res,rej)=>{
        const reader = new FileReader(); reader.onload = ()=>res(reader.result); reader.onerror = ()=>rej(new Error('Failed to read file')); reader.readAsDataURL(file);
      });
    }
    async function downsizeDataUrlIfNeeded(dataUrl){
      try{
        const approxKb = Math.ceil((dataUrl.length * 3/4) / 1024);
        if(approxKb <= 800) return dataUrl;
        const img = await new Promise((res, rej)=>{const i=new Image(); i.onload=()=>res(i); i.onerror=()=>rej(new Error('img load fail')); i.src=dataUrl});
        const maxDim = 1200; let w=img.width,h=img.height;
        if(w>maxDim||h>maxDim){ const ratio = Math.min(maxDim/w,maxDim/h); w=Math.round(w*ratio); h=Math.round(h*ratio); }
        const canv = document.createElement('canvas'); canv.width=w; canv.height=h; const ctx=canv.getContext('2d'); ctx.drawImage(img,0,0,w,h);
        return canv.toDataURL('image/jpeg',0.8);
      } catch(e){ return dataUrl; }
    }

    pSave.addEventListener('click', async ()=>{
      const title = pTitle.value.trim(); const description = pDesc.value.trim(); const price = parseFloat(pPrice.value)||0; const quantity = parseInt(pQty.value)||0;
      if(!title) return alert('Add a title');
      // require admin code when saving
      const code = prompt('Enter admin code to add product'); if(code!== '555') return alert('Wrong code');
      let imageData = '';
      const file = pImageFile.files && pImageFile.files[0];
      try{
        if(file){ document.getElementById('uploadingNote').style.display='block'; pSave.disabled=true; const dataUrl = await readFileAsDataURL(file); imageData = await downsizeDataUrlIfNeeded(dataUrl); document.getElementById('uploadingNote').style.display='none'; pSave.disabled=false; }
      } catch(err){ document.getElementById('uploadingNote').style.display='none'; pSave.disabled=false; return alert('Image processing failed: '+err.message); }
      const newRef = db.ref('products').push();
      newRef.set({title,description,price,quantity,imageData,createdAt:Date.now()}).then(()=>{ alert('Product saved'); pTitle.value=''; pDesc.value=''; pPrice.value=''; pQty.value=''; pImageFile.value=''; showPage('home'); }).catch(err=>alert('Error: '+err.message));
    });
    pCancelPage.addEventListener('click', ()=> showPage('home'));

    // render products from DB
    function renderProducts(snapshot){
      productsEl.innerHTML='';
      const val = snapshot.val() || {};
      const entries = Object.entries(val);
      if(entries.length===0){ productsEl.innerHTML='<div class="muted">No products yet. Add one!</div>'; return; }
      entries.sort((a,b)=> (b[1].createdAt||0)-(a[1].createdAt||0));
      entries.forEach(([id,data])=>{
        const card = document.createElement('div'); card.className='pcard';
        const art = document.createElement('div'); art.className='art';
        if(data.imageData){ const img = document.createElement('img'); img.src = data.imageData; img.alt = data.title || 'product'; art.appendChild(img); } else { const ph = document.createElement('div'); ph.className='muted'; ph.textContent = 'No image'; art.appendChild(ph); }
        card.appendChild(art);
        const content = document.createElement('div'); content.className='content';
        const title = document.createElement('h3'); title.textContent = data.title || ''; content.appendChild(title);
        const desc = document.createElement('div'); desc.className='muted'; desc.textContent = data.description || ''; content.appendChild(desc);
        const stats = document.createElement('div'); stats.className='stats';
        const price = document.createElement('div'); price.className='stat'; price.innerHTML = '<span class="moneyicon">ðŸ’°</span>' + (Number(data.price).toFixed(2)||'0.00');
        const qty = document.createElement('div'); qty.className='stat'; qty.textContent = 'Qty: '+(data.quantity||0);
        stats.appendChild(price); stats.appendChild(qty); content.appendChild(stats); card.appendChild(content);
        const footer = document.createElement('div'); footer.className='pfooter';
        const addBtn = document.createElement('button'); addBtn.className='btn small'; addBtn.textContent='Add to cart'; addBtn.disabled = !(data.quantity>0);
        addBtn.addEventListener('click', ()=> addToCart(id,data)); footer.appendChild(addBtn);
        // direct buy button: goes to cart and opens it
        const buyBtn = document.createElement('button'); buyBtn.className='btn small'; buyBtn.style.marginLeft='8px'; buyBtn.textContent='Buy'; buyBtn.addEventListener('click', ()=>{ addToCart(id,data); showPage('cart'); }); footer.appendChild(buyBtn);
        // delete: admin-only (prompt code)
        const deleteBtn = document.createElement('button'); deleteBtn.className='btn small danger'; deleteBtn.style.marginLeft='8px'; deleteBtn.textContent='Delete';
        deleteBtn.addEventListener('click', async ()=>{
          const code = prompt('Enter admin code to delete'); if(code !== '555') return alert('Wrong code'); if(!confirm('Delete product "'+(data.title||'')+'"?')) return; await db.ref('products/'+id).remove(); alert('Deleted');
        }); footer.appendChild(deleteBtn);
        const meta = document.createElement('div'); meta.style.marginLeft='auto'; meta.className='muted'; meta.style.fontSize='12px'; meta.textContent = new Date((data.createdAt||0)).toLocaleDateString(); footer.appendChild(meta);
        card.appendChild(footer); productsEl.appendChild(card);
      });
    }

    db.ref('products').on('value', renderProducts);

    // ---------- Orders rendering & admin actions ----------
    function renderMyOrders(){ myOrdersList.innerHTML=''; if(!currentUser){ myOrdersList.innerHTML='<div class="muted">Login to view your orders</div>'; return; }
      db.ref('orders').orderByChild('buyerId').equalTo(currentUser.id).once('value').then(snap=>{
        const val = snap.val() || {};
        const items = Object.entries(val).sort((a,b)=> (b[1].createdAt||0)-(a[1].createdAt||0));
        if(items.length===0){ myOrdersList.innerHTML='<div class="muted">No orders found</div>'; return; }
        items.forEach(([id,data])=>{
          const box = document.createElement('div'); box.className='ticket';
          const top = document.createElement('div'); top.className='flex'; const title = document.createElement('div'); title.innerHTML='<strong>'+data.productTitle+'</strong>'; const badge = document.createElement('div'); badge.className='badge'; badge.style.marginLeft='auto'; badge.textContent=(data.status||'pending'); top.appendChild(title); top.appendChild(badge); box.appendChild(top);
          const info = document.createElement('div'); info.className='muted'; info.style.marginTop='6px'; info.innerHTML = 'Qty: '+(data.quantity||0)+' â€” Day: '+(data.day||'')+'<br/>' + new Date((data.createdAt||0)).toLocaleString(); box.appendChild(info);
          const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px'; actions.style.marginTop='8px';
          const cancel = document.createElement('button'); cancel.className='btn small danger'; cancel.textContent='Cancel';
          cancel.addEventListener('click', ()=>{ if(!confirm('Cancel this order?')) return; handleCancelOrder(id,data); });
          actions.appendChild(cancel); box.appendChild(actions); myOrdersList.appendChild(box);
        });
      }); }

    async function handleCancelOrder(orderId, orderData){
      try{
        if(orderData.status === 'accepted'){
          // restore product quantity
          await db.ref('products/'+orderData.productId+'/quantity').transaction(current => (current||0) + (orderData.quantity||0));
        }
        await db.ref('orders/'+orderId).update({status:'cancelled', handledAt:Date.now()});
        alert('Order cancelled'); renderMyOrders();
      } catch(e){ alert('Failed to cancel: '+e.message); }
    }

    // Admin area: requires admin code to view
    document.getElementById('btnAdminOrders').addEventListener('click', ()=>{
      const code = prompt('Enter admin code to open orders'); if(code !== '555'){ alert('Wrong code'); return; }
      showPage('adminOrders');
    });

    async function renderAdminOrders(){ ordersList.innerHTML=''; db.ref('orders').once('value').then(snap=>{
      const val = snap.val() || {};
      const entries = Object.entries(val).sort((a,b)=> (b[1].createdAt||0)-(a[1].createdAt||0));
      if(entries.length===0){ ordersList.innerHTML='<div class="muted">No orders yet</div>'; return; }
      entries.forEach(([id,data])=>{
        const box = document.createElement('div'); box.className='ticket';
        const top = document.createElement('div'); top.className='flex'; const title = document.createElement('div'); title.innerHTML='<strong>'+data.productTitle+'</strong>'; const badge = document.createElement('div'); badge.className='badge'; badge.style.marginLeft='auto'; badge.textContent=(data.status||'pending'); top.appendChild(title); top.appendChild(badge); box.appendChild(top);
        const info = document.createElement('div'); info.className='muted'; info.style.marginTop='6px'; info.innerHTML = 'Buyer: '+(data.buyerName||'')+' â€” Qty: '+(data.quantity||0)+' â€” Day: '+(data.day||'')+'<br/>' + new Date((data.createdAt||0)).toLocaleString(); box.appendChild(info);
        const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px'; actions.style.marginTop='8px';
        const accept = document.createElement('button'); accept.className='btn small'; accept.textContent='Accept';
        accept.addEventListener('click', ()=> handleAdminChange(id,data,'accepted'));
        const decline = document.createElement('button'); decline.className='btn small danger'; decline.textContent='Decline'; decline.addEventListener('click', ()=> handleAdminChange(id,data,'declined'));
        const deliver = document.createElement('button'); deliver.className='btn small'; deliver.textContent='Delivered'; deliver.addEventListener('click', ()=> handleAdminChange(id,data,'delivered'));
        actions.appendChild(accept); actions.appendChild(decline); actions.appendChild(deliver); box.appendChild(actions); ordersList.appendChild(box);
      });
    }); }

    async function handleAdminChange(orderId, orderData, newStatus){
      try{
        if(newStatus === 'accepted'){
          // decrease product quantity via transaction
          await db.ref('products/'+orderData.productId+'/quantity').transaction(current => {
            current = current||0; const next = current - (orderData.quantity||0); return next<0?0:next;
          });
          await db.ref('orders/'+orderId).update({status:'accepted', handledAt:Date.now()});
        } else if(newStatus === 'declined'){
          // if previously accepted, restore quantity
          if(orderData.status === 'accepted'){
            await db.ref('products/'+orderData.productId+'/quantity').transaction(current => (current||0) + (orderData.quantity||0));
          }
          await db.ref('orders/'+orderId).update({status:'declined', handledAt:Date.now()});
        } else if(newStatus === 'delivered'){
          await db.ref('orders/'+orderId).update({status:'delivered', handledAt:Date.now()});
        }
        alert('Order updated to '+newStatus);
        renderAdminOrders();
      } catch(e){ alert('Failed to update: '+e.message); }
    }

    // ---------- My Cart quick add integration: header buttons
    document.getElementById('btnAddProduct').addEventListener('click', ()=>{ const code = prompt('Enter admin code'); if(code !== '555') return alert('Wrong code'); showPage('add'); });
    document.getElementById('btnAddProduct').style.display='none'; // original button hidden; we use topbar link

    document.getElementById('btnAddProduct')?.addEventListener('click', ()=> showPage('add'));

    // header links already use hash routing; intercept add-product to require code
    document.getElementById('btnAddProduct')?.addEventListener('click', ()=>{});

    // intercept clicks on hash links for add-product to ask code
    document.getElementById('btnAddProduct').addEventListener('click', ()=>{});

    // navigation links (we have anchors â€” routeFromHash handles display)
    // initialize cart count
    updateCartCount();

    // show tutorial on first load (always per request)
    showTutorialBlock();

    // on load routing
    routeFromHash();

    // accessibility: allow Escape to hide tutorial after it's enabled
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ tutorialModal.classList.add('hidden') } });

  </script>
</body>
</html>
